<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>php字节跳动小程序支付 | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/assets/css/0.styles.6b9be157.css" as="style"><link rel="preload" href="/assets/js/app.cbc27ffd.js" as="script"><link rel="preload" href="/assets/js/2.26d918e1.js" as="script"><link rel="preload" href="/assets/js/24.d84de391.js" as="script"><link rel="prefetch" href="/assets/js/10.8324ee53.js"><link rel="prefetch" href="/assets/js/11.b3fae781.js"><link rel="prefetch" href="/assets/js/12.2f57424d.js"><link rel="prefetch" href="/assets/js/13.a1bd9044.js"><link rel="prefetch" href="/assets/js/14.a21b9547.js"><link rel="prefetch" href="/assets/js/15.a55f5787.js"><link rel="prefetch" href="/assets/js/16.69ae7d01.js"><link rel="prefetch" href="/assets/js/17.8305f7c6.js"><link rel="prefetch" href="/assets/js/18.5f682b15.js"><link rel="prefetch" href="/assets/js/19.a8e0ad12.js"><link rel="prefetch" href="/assets/js/20.d64b0ffc.js"><link rel="prefetch" href="/assets/js/21.bb3d1ce8.js"><link rel="prefetch" href="/assets/js/22.2807caaf.js"><link rel="prefetch" href="/assets/js/23.d7d23893.js"><link rel="prefetch" href="/assets/js/25.028292c4.js"><link rel="prefetch" href="/assets/js/26.e48e58fe.js"><link rel="prefetch" href="/assets/js/27.81a50ac9.js"><link rel="prefetch" href="/assets/js/28.c9b99067.js"><link rel="prefetch" href="/assets/js/29.3e398b0e.js"><link rel="prefetch" href="/assets/js/3.bf921ca6.js"><link rel="prefetch" href="/assets/js/30.eda8afc0.js"><link rel="prefetch" href="/assets/js/31.4df929c1.js"><link rel="prefetch" href="/assets/js/32.883b799d.js"><link rel="prefetch" href="/assets/js/33.edff820f.js"><link rel="prefetch" href="/assets/js/34.a40dfb52.js"><link rel="prefetch" href="/assets/js/35.f84b2527.js"><link rel="prefetch" href="/assets/js/36.d9686c50.js"><link rel="prefetch" href="/assets/js/37.7e04f937.js"><link rel="prefetch" href="/assets/js/38.7e0cf189.js"><link rel="prefetch" href="/assets/js/39.06edca1d.js"><link rel="prefetch" href="/assets/js/4.01616d0a.js"><link rel="prefetch" href="/assets/js/40.556d0c76.js"><link rel="prefetch" href="/assets/js/41.9370ec30.js"><link rel="prefetch" href="/assets/js/42.efb2b09e.js"><link rel="prefetch" href="/assets/js/43.230fd681.js"><link rel="prefetch" href="/assets/js/44.f8baf234.js"><link rel="prefetch" href="/assets/js/45.9434cbfb.js"><link rel="prefetch" href="/assets/js/46.5ceab43d.js"><link rel="prefetch" href="/assets/js/47.49c5f096.js"><link rel="prefetch" href="/assets/js/48.94111e03.js"><link rel="prefetch" href="/assets/js/49.b430e466.js"><link rel="prefetch" href="/assets/js/5.103b1fc9.js"><link rel="prefetch" href="/assets/js/50.5576e684.js"><link rel="prefetch" href="/assets/js/51.868924b4.js"><link rel="prefetch" href="/assets/js/52.13030538.js"><link rel="prefetch" href="/assets/js/53.d14e23b5.js"><link rel="prefetch" href="/assets/js/54.692ba555.js"><link rel="prefetch" href="/assets/js/55.e7f4ee2b.js"><link rel="prefetch" href="/assets/js/56.b2192bd2.js"><link rel="prefetch" href="/assets/js/57.7f33c3ce.js"><link rel="prefetch" href="/assets/js/58.bebb810c.js"><link rel="prefetch" href="/assets/js/59.3bb5c8e3.js"><link rel="prefetch" href="/assets/js/6.8d2cb690.js"><link rel="prefetch" href="/assets/js/60.f7d443a1.js"><link rel="prefetch" href="/assets/js/61.03c84be3.js"><link rel="prefetch" href="/assets/js/62.4d23f330.js"><link rel="prefetch" href="/assets/js/63.9b7eb6eb.js"><link rel="prefetch" href="/assets/js/64.c9a3f7a5.js"><link rel="prefetch" href="/assets/js/65.f18871f6.js"><link rel="prefetch" href="/assets/js/66.3d2c74a6.js"><link rel="prefetch" href="/assets/js/67.df9620fc.js"><link rel="prefetch" href="/assets/js/68.4c78fe6f.js"><link rel="prefetch" href="/assets/js/69.5298627a.js"><link rel="prefetch" href="/assets/js/7.77ce0fba.js"><link rel="prefetch" href="/assets/js/70.269c5ebf.js"><link rel="prefetch" href="/assets/js/71.14b994cb.js"><link rel="prefetch" href="/assets/js/72.6e1a94ad.js"><link rel="prefetch" href="/assets/js/73.327ce2fa.js"><link rel="prefetch" href="/assets/js/74.9535cbd0.js"><link rel="prefetch" href="/assets/js/8.a85b50e1.js"><link rel="prefetch" href="/assets/js/9.f7ed37b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b9be157.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="sidebar-link">模拟 JavaScript 中常见的内置方法</a></li><li><a href="/daily-learn/JavaScript/commonModule-vs-ESM.html" class="sidebar-link">export, export default和exports、module.exports的区别与联系</a></li><li><a href="/daily-learn/JavaScript/learn-closure.html" class="sidebar-link">JavaScript闭包</a></li><li><a href="/daily-learn/JavaScript/learn-functional.html" class="sidebar-link">函数式编程学习</a></li><li><a href="/daily-learn/JavaScript/let-var-const.html" class="sidebar-link">JS中let、var、和const的区别</a></li><li><a href="/daily-learn/JavaScript/konwledge-point.html" class="sidebar-link">JavaScript 小知识点</a></li><li><a href="/daily-learn/JavaScript/browser-relevant.html" class="sidebar-link">浏览器：文档，事件，接口</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PHP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Scaffold</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="php字节跳动小程序支付"><a href="#php字节跳动小程序支付" class="header-anchor">#</a> php字节跳动小程序支付</h1> <p>由于字节跳动的开发文档可以说是非常节俭，可以说是节俭到有时候必要的一个完整的<code>demo</code>都没有，所以你在看他的开发文档时有时候会怀疑人生，尤其是在支付这块，由于字节跳动没有自己的支付渠道，且与鹅厂关系的原因，现在只支持<strong>支付宝<code>APP</code>支付</strong>，注意支付宝手机支付是不行的。</p> <h2 id="支付流程"><a href="#支付流程" class="header-anchor">#</a> 支付流程</h2> <p>流程图可以去看<a href="https://developer.toutiao.com/docs/payment/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，其中详情见文档几点几节，不要问我，我至今也没有找到。</p> <p>支付的具体流程：首先前端通过<code>tt.login()</code>获取到登录凭证，然后服务端通过此凭证向字节跳动发送请求获得用户的<code>open_id</code>，然后服务端通过<code>open_id</code>和自己的订单号生成一个头条的订单号，然后生成支付宝支付的<code>url</code>，最后将相关参数组装后返回给前端，通过<code>tt.requestPayment()</code>吊起支付宝支付。</p> <h2 id="前端请求代码"><a href="#前端请求代码" class="header-anchor">#</a> 前端请求代码</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// pages/pay/index.js</span>
<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">//调用login接口返回的登陆凭证</span>
    code<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">//用户的open_id</span>
    open_id<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">//订单号</span>
    ordercode<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">//支付宝请求所需参数</span>
    orderParam<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/**
   * 页面加载，获取支付参数直接吊起支付
   */</span>
  <span class="token function-variable function">onLoad</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>ordercode<span class="token punctuation">)</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//判断ordercode是否存在</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>ordercode<span class="token operator">||</span>options<span class="token punctuation">.</span>ordercode<span class="token operator">==</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'参数错误'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>  
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">//获取订单号</span>
    that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      ordercode<span class="token operator">:</span>options<span class="token punctuation">.</span>ordercode
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    tt<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">'收银台努力加载中...'</span><span class="token punctuation">,</span>
        <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           that<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">fail</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">showLoading调用失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/*获取用户的临时登陆凭证*/</span>
  <span class="token function-variable function">getCode</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token comment">//调取login接口</span>
    tt<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          code<span class="token operator">:</span>res<span class="token punctuation">.</span>code
        <span class="token punctuation">}</span><span class="token punctuation">)</span> 
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">login调用成功</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>anonymousCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用获取用户openid的接口</span>
        that<span class="token punctuation">.</span><span class="token function">getOpenID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'login 调用失败'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/*获取用户的open_id*/</span>
  <span class="token function-variable function">getOpenID</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//调用后端获取用户openid接口</span>
    tt<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token operator">:</span> <span class="token string">'https://XXXXXXXX'</span><span class="token punctuation">,</span> <span class="token comment">// 目标服务器url</span>
      data<span class="token operator">:</span><span class="token punctuation">{</span>
        code<span class="token operator">:</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      header<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span>  <span class="token comment">//post</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'后端获取open_id失败'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            open_id<span class="token operator">:</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">//调用获取支付宝请求参数</span>
          that<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'后端open_id接口调用失败'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/*获取支付宝请求参数*/</span>
  <span class="token function-variable function">getOrder</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    tt<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token operator">:</span> <span class="token string">'https://XXXXXX'</span><span class="token punctuation">,</span> <span class="token comment">// 目标服务器url</span>
      data<span class="token operator">:</span><span class="token punctuation">{</span>
        ordercode<span class="token operator">:</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ordercode<span class="token punctuation">,</span>
        open_id<span class="token operator">:</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>open_id
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      header<span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span>  <span class="token comment">//post</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'后端获取支付宝参数失败'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          <span class="token comment">//将获得的支付请求数据绑定</span>
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            orderParam<span class="token operator">:</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment">//调用支付请求</span>
          that<span class="token punctuation">.</span><span class="token function">payRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'后端orderParam接口调用失败'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//调用支付宝进行支付</span>
  <span class="token function-variable function">payRequest</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tt<span class="token punctuation">.</span><span class="token function">requestPayment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        app_id<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>app_id<span class="token punctuation">,</span>
        method<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
        sign<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>sign<span class="token punctuation">,</span>
        sign_type<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>sign_type<span class="token punctuation">,</span>
        timestamp<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
        trade_no<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>
        merchant_id<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>merchant_id<span class="token punctuation">,</span>
        uid<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
        total_amount<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>total_amount<span class="token punctuation">,</span>
        pay_channel<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>pay_channel<span class="token punctuation">,</span>
        pay_type<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>pay_type<span class="token punctuation">,</span>
        risk_info<span class="token operator">:</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'ip'</span><span class="token operator">:</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>risk_info<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        params<span class="token operator">:</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
        return_url<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>orderParam<span class="token punctuation">.</span>return_url<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
          tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token operator">:</span> <span class="token string">'支付成功！'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
            duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
            icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">setTimeout</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span><span class="token function">orderDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        tt<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token string">'支付失败！'</span><span class="token punctuation">,</span> <span class="token comment">// 内容</span>
          duration<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>
          icon<span class="token operator">:</span><span class="token string">'none'</span><span class="token punctuation">,</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>tt<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//支付成功跳转结果页</span>
  <span class="token function-variable function">orderDetail</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ordercode <span class="token operator">=</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ordercode<span class="token punctuation">;</span>
     tt<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/detail/index?ordercode=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ordercode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">fail</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">详情页调用失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br></div></div><h2 id="后端接口代码"><a href="#后端接口代码" class="header-anchor">#</a> 后端接口代码</h2> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>pay<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Access-Control-Allow-Origin: *'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, run-token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Access-Control-Allow-Methods: GET, POST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">alipay<span class="token punctuation">\</span>AlipayTradeAppPayRequest</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">alipay<span class="token punctuation">\</span>AopClient</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>common<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Orders</span> <span class="token keyword">as</span> OrdersModel<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>pay<span class="token punctuation">\</span>validate<span class="token punctuation">\</span>TypePayParamsValidate</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Config</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Paytype</span> <span class="token keyword">extends</span>  <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token comment">//字节登陆接口地址</span>
    <span class="token keyword">protected</span>  <span class="token variable">$login_url</span> <span class="token operator">=</span><span class="token string double-quoted-string">&quot;https://developer.toutiao.com/api/apps/jscode2session?&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//字节分配的小程序appID</span>
    <span class="token keyword">protected</span>  <span class="token variable">$appID</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token comment">//字节分配的小程序appSecret</span>
    <span class="token keyword">protected</span>  <span class="token variable">$appSecret</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token comment">//字节跳动分配的支付app_id</span>
    <span class="token keyword">protected</span> <span class="token variable">$app_id</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token comment">//接口名称</span>
    <span class="token keyword">protected</span> <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'tp.trade.create'</span><span class="token punctuation">;</span>
    <span class="token comment">//请求编码</span>
    <span class="token keyword">protected</span> <span class="token variable">$charset</span> <span class="token operator">=</span><span class="token string single-quoted-string">'utf-8'</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$format</span> <span class="token operator">=</span><span class="token string single-quoted-string">'JSON'</span><span class="token punctuation">;</span>
    <span class="token comment">//签名算法类型</span>
    <span class="token keyword">protected</span> <span class="token variable">$sign_type</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'MD5'</span><span class="token punctuation">;</span>
    <span class="token comment">//请求交易的时间戳</span>
    <span class="token keyword">protected</span> <span class="token variable">$timestamp</span><span class="token punctuation">;</span>
    <span class="token comment">//调用接口的版本</span>
    <span class="token keyword">protected</span> <span class="token variable">$version</span><span class="token operator">=</span><span class="token string single-quoted-string">'1.0'</span><span class="token punctuation">;</span>
    <span class="token comment">//字节下单请求地址</span>
    <span class="token keyword">protected</span> <span class="token variable">$trade_url</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;https://tp-pay.snssdk.com/gateway?&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//头条分配的商户号</span>
    <span class="token keyword">protected</span> <span class="token variable">$merchant_id</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token comment">//币种</span>
    <span class="token keyword">protected</span> <span class="token variable">$currency</span><span class="token operator">=</span><span class="token string single-quoted-string">'CNY'</span><span class="token punctuation">;</span>
    <span class="token comment">//订单名称</span>
    <span class="token keyword">protected</span> <span class="token variable">$subject</span><span class="token punctuation">;</span>
    <span class="token comment">//订单详情</span>
    <span class="token keyword">protected</span> <span class="token variable">$body</span><span class="token punctuation">;</span>
    <span class="token comment">//订单拉起头条下单接口的有效时间 秒为单位  </span>
    <span class="token keyword">protected</span> <span class="token variable">$valid_time</span> <span class="token operator">=</span><span class="token number">30000</span><span class="token punctuation">;</span>
    <span class="token comment">//风控信息  传入用户的真实ip</span>
    <span class="token keyword">protected</span> <span class="token variable">$risk_info</span><span class="token punctuation">;</span>
    <span class="token comment">//头条支付密钥</span>
    <span class="token keyword">protected</span> <span class="token variable">$app_secret</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

    <span class="token comment">//支付渠道</span>
    <span class="token keyword">protected</span> <span class="token variable">$pay_chanel</span><span class="token punctuation">;</span>
    <span class="token comment">//支付方式</span>
    <span class="token keyword">protected</span>  <span class="token variable">$pay_type</span><span class="token punctuation">;</span>
    <span class="token comment">//支付宝下单接口对应的异步通知url</span>
    <span class="token keyword">protected</span> <span class="token variable">$notify_url</span><span class="token punctuation">;</span>
    <span class="token comment">//支付宝完成支付返回的地址</span>
    <span class="token keyword">protected</span> <span class="token variable">$return_url</span><span class="token punctuation">;</span>
    <span class="token comment">//支付宝支付失败返回的地址</span>
    <span class="token keyword">protected</span> <span class="token variable">$show_url</span><span class="token punctuation">;</span>
    <span class="token comment">//设置alipay的product_code  使得返回的是字符串而不是表单</span>
    <span class="token keyword">protected</span> <span class="token variable">$product_code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'QUICK_MSECURITY_PAY'</span><span class="token punctuation">;</span>
    <span class="token comment">//设置alipay该笔订单最晚支付时间 90分钟  最多不能超过15d</span>
    <span class="token keyword">protected</span> <span class="token variable">$timeout_express</span><span class="token operator">=</span><span class="token string single-quoted-string">'90m'</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 构造方法
     * @param 实例化对象
     * @access public
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timestamp</span><span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">risk_info</span><span class="token operator">=</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     *访问不存在的接口时返回错误信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">404</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'指定接口不存在！'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 设置支付渠道
     * @parameter  $pay_chanel string  支付渠道  默认为空字符串
     * @return string  默认ALIPAY_NO_SIGN，支付宝
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setPayChanel</span><span class="token punctuation">(</span><span class="token variable">$pay_chanel</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pay_chanel</span> <span class="token operator">=</span> <span class="token variable">$pay_chanel</span><span class="token operator">?</span><span class="token variable">$pay_chanel</span><span class="token punctuation">:</span><span class="token string single-quoted-string">'ALIPAY_NO_SIGN'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 设置支付方式
     * @parameter  $pay_type string  支付方式  默认为空字符串
     * @return string  默认ALIPAY_APP，支付宝
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setPayType</span><span class="token punctuation">(</span><span class="token variable">$pay_type</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pay_type</span> <span class="token operator">=</span> <span class="token variable">$pay_type</span><span class="token operator">?</span><span class="token variable">$pay_type</span><span class="token punctuation">:</span><span class="token string single-quoted-string">'ALIPAY_APP'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 字节跳动下单接口
     * @parameter  $out_order_no string 用户下单的订单号
     * @parameter  $open_id string 用户的唯一标识id
     * @return  mixed  字节跳动分配的内部订单号或者错误信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">orderApi</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span> <span class="token variable">$open_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取订单相关信息</span>
        <span class="token variable">$order_info</span> <span class="token operator">=</span> <span class="token class-name static-context">OrdersModel</span><span class="token operator">::</span><span class="token function">getOrderInfoByOrdercode</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//金额 分为单位</span>
            <span class="token variable">$total_amount</span> <span class="token operator">=</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'fee'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">;</span>
            <span class="token comment">//下单时间</span>
            <span class="token variable">$trade_time</span> <span class="token operator">=</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'createtime'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//订单名称</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">subject</span> <span class="token operator">=</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string single-quoted-string">'订单名称'</span><span class="token punctuation">;</span>
            <span class="token comment">//订单详情</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">body</span> <span class="token operator">=</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'description'</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'description'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string single-quoted-string">'订单详情'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'订单未找到'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置业务请求参数</span>
        <span class="token variable">$risk_info</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'ip'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">risk_info</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$biz_content</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token string single-quoted-string">'out_order_no'</span><span class="token operator">=&gt;</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'uid'</span><span class="token operator">=&gt;</span><span class="token variable">$open_id</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'merchant_id'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">merchant_id</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'total_amount'</span><span class="token operator">=&gt;</span><span class="token variable">$total_amount</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'currency'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">currency</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'subject'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">subject</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'body'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">body</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'trade_time'</span><span class="token operator">=&gt;</span><span class="token variable">$trade_time</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'valid_time'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">valid_time</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'notify_url'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">notify_url</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'risk_info'</span><span class="token operator">=&gt;</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$risk_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置请求参数</span>
        <span class="token variable">$request_params</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token string single-quoted-string">'app_id'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">app_id</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;method&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">method</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;charset&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">charset</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;sign_type&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sign_type</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;timestamp&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timestamp</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;version&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">version</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'biz_content'</span><span class="token operator">=&gt;</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$biz_content</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获得拼接待签名字符串</span>
        <span class="token variable">$sign_str</span><span class="token operator">=</span><span class="token function">arr2string</span><span class="token punctuation">(</span><span class="token variable">$request_params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成MD5签名</span>
        <span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token variable">$sign_str</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">app_secret</span><span class="token punctuation">;</span>
        <span class="token variable">$request_params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sign'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拼接请求字符串</span>
        <span class="token variable">$request_str</span><span class="token operator">=</span><span class="token function">arr2string</span><span class="token punctuation">(</span><span class="token variable">$request_params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求地址</span>
        <span class="token variable">$url</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">trade_url</span><span class="token punctuation">;</span>
        <span class="token comment">//进行post请求 这里是自己封装的请求方法</span>
        <span class="token variable">$http_response</span><span class="token operator">=</span><span class="token function">sendHttpRequest</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span><span class="token variable">$request_str</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$http_response</span><span class="token operator">=</span><span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对请求的返回结果进行判断</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token operator">-&gt;</span><span class="token property">response</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token operator">==</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回字节给予的交易单号</span>
            <span class="token variable">$trade_no</span><span class="token operator">=</span><span class="token variable">$http_response</span><span class="token operator">-&gt;</span><span class="token property">response</span><span class="token operator">-&gt;</span><span class="token property">trade_no</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$trade_no</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'下单失败，请稍后重试！'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 字节跳动调用支付所需的请求参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">orderParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//验证器验证参数</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypePayParamsValidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取商品订单号</span>
        <span class="token variable">$out_order_no</span><span class="token operator">=</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.ordercode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取用户的open_id</span>
        <span class="token variable">$open_id</span> <span class="token operator">=</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.open_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用下单接口 获得字节内部订单号</span>
        <span class="token variable">$trade_no</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">orderApi</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span><span class="token variable">$open_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取订单相关信息</span>
        <span class="token variable">$order_info</span> <span class="token operator">=</span> <span class="token class-name static-context">OrdersModel</span><span class="token operator">::</span><span class="token function">getOrderInfoByOrdercode</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用支付宝sdk签名参数方法</span>
        <span class="token variable">$paramsSDK</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">alipayGet</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获得支付宝 url</span>
        <span class="token variable">$params</span><span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'url'</span><span class="token operator">=&gt;</span><span class="token variable">$paramsSDK</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//金额 分为单位</span>
            <span class="token variable">$total_amount</span> <span class="token operator">=</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'fee'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'订单未找到'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置支付渠道和支付方式</span>
        <span class="token variable">$pay_chanel</span><span class="token operator">=</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.pay_chanel'</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.pay_chanel'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token variable">$pay_type</span> <span class="token operator">=</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.pay_type'</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.pay_type'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setPayChanel</span><span class="token punctuation">(</span><span class="token variable">$pay_chanel</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setPayType</span><span class="token punctuation">(</span><span class="token variable">$pay_type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$order_params</span><span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'app_id'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">app_id</span><span class="token punctuation">,</span>
            <span class="token comment">//固定方法</span>
            <span class="token string single-quoted-string">'method'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'tp.trade.confirm'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'sign_type'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sign_type</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'uid'</span><span class="token operator">=&gt;</span><span class="token variable">$open_id</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'timestamp'</span><span class="token operator">=&gt;</span><span class="token function">strval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timestamp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'trade_no'</span><span class="token operator">=&gt;</span><span class="token variable">$trade_no</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'merchant_id'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">merchant_id</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'total_amount'</span><span class="token operator">=&gt;</span><span class="token variable">$total_amount</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'pay_channel'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pay_chanel</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'pay_type'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pay_type</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'risk_info'</span><span class="token operator">=&gt;</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">risk_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'params'</span><span class="token operator">=&gt;</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'return_url'</span><span class="token operator">=&gt;</span><span class="token variable">$paramsSDK</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'return_url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$signKeys</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;app_id&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;sign_type&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;timestamp&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;trade_no&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;merchant_id&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;uid&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;total_amount&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;params&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signData</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$signKeys</span> <span class="token keyword">as</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$signData</span><span class="token punctuation">[</span><span class="token variable">$v</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$order_params</span><span class="token punctuation">[</span><span class="token variable">$v</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//获得拼接待签名字符串</span>
        <span class="token variable">$sign_str</span><span class="token operator">=</span><span class="token function">arr2string</span><span class="token punctuation">(</span><span class="token variable">$signData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成MD5签名</span>
        <span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token variable">$sign_str</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">app_secret</span><span class="token punctuation">;</span>
        <span class="token variable">$order_params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sign'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$order_params</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'下单成功！'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * alipay支付宝请求string
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">alipayGet</span><span class="token punctuation">(</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;alipay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AopClient</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">gatewayUrl</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'gatewayUrl'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">appId</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'app_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">rsaPrivateKey</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'merchant_private_key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">format</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;json&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">charset</span> <span class="token operator">=</span>  <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'charset'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">signType</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sign_type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token property">alipayrsaPublicKey</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'alipay_public_key'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.trade.app.pay</span>
        <span class="token variable">$request</span> <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AlipayTradeAppPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//SDK已经封装掉了公共参数，这里只需要传入业务参数</span>
        <span class="token variable">$bizcontent</span><span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token string double-quoted-string">&quot;body&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;subject&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;out_trade_no&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$out_order_no</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;timeout_express&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">timeout_express</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;total_amount&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'fee'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">&quot;producct_code&quot;</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">product_code</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$bizcontent</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$bizcontent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'notify_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token variable">$bizcontent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里和普通的接口调用不同，使用的是sdkExecute</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$aop</span><span class="token operator">-&gt;</span><span class="token function">sdkExecute</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$params</span><span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'return_url'</span><span class="token operator">=&gt;</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'return_url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'url'</span><span class="token operator">=&gt;</span><span class="token variable">$response</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$params</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     *根据头条login获得的code请求用户的open_id
     * @param string $code 前端调用login api获得的code
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getOpenID</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//拼接请求参数</span>
        <span class="token variable">$request_str</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'appid='</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">appID</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;secret='</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">appSecret</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;code='</span><span class="token operator">.</span><span class="token variable">$code</span><span class="token punctuation">;</span>
        <span class="token comment">//请求open_id 自己封装的请求方法</span>
        <span class="token variable">$http_response</span> <span class="token operator">=</span><span class="token function">sendHttpRequest</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">login_url</span><span class="token punctuation">,</span><span class="token variable">$request_str</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$http_response</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'获取session_key及open_id时异常，字节跳动内部错误'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//判断请求是否出错</span>
            <span class="token variable">$login_fail</span> <span class="token operator">=</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">,</span><span class="token variable">$http_response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$login_fail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$http_response</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errmsg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$http_response</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'获取open_id成功'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br></div></div><p>注：相关支付宝<code>SDK</code>问题，请查阅<a href="https://docs.open.alipay.com/204" target="_blank" rel="noopener noreferrer">支付宝官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这里直接用的文档中的<code>php</code>请求demo，支付宝相关支付问题请<a href="https://openclub.alipay.com/club/history/read/7695" target="_blank" rel="noopener noreferrer">查阅<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/recoveryMonster/vuepress-blog/edit/master/docs/daily-learn/PHP/php-typedance-pay-mini.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/18/2020, 11:31:46 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.cbc27ffd.js" defer></script><script src="/assets/js/2.26d918e1.js" defer></script><script src="/assets/js/24.d84de391.js" defer></script>
  </body>
</html>
