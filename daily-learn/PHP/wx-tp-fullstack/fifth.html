<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序商城构建全栈应用（五） | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/assets/css/0.styles.6b9be157.css" as="style"><link rel="preload" href="/assets/js/app.cbc27ffd.js" as="script"><link rel="preload" href="/assets/js/2.26d918e1.js" as="script"><link rel="preload" href="/assets/js/30.eda8afc0.js" as="script"><link rel="prefetch" href="/assets/js/10.8324ee53.js"><link rel="prefetch" href="/assets/js/11.b3fae781.js"><link rel="prefetch" href="/assets/js/12.2f57424d.js"><link rel="prefetch" href="/assets/js/13.a1bd9044.js"><link rel="prefetch" href="/assets/js/14.a21b9547.js"><link rel="prefetch" href="/assets/js/15.a55f5787.js"><link rel="prefetch" href="/assets/js/16.69ae7d01.js"><link rel="prefetch" href="/assets/js/17.8305f7c6.js"><link rel="prefetch" href="/assets/js/18.5f682b15.js"><link rel="prefetch" href="/assets/js/19.a8e0ad12.js"><link rel="prefetch" href="/assets/js/20.d64b0ffc.js"><link rel="prefetch" href="/assets/js/21.bb3d1ce8.js"><link rel="prefetch" href="/assets/js/22.2807caaf.js"><link rel="prefetch" href="/assets/js/23.d7d23893.js"><link rel="prefetch" href="/assets/js/24.d84de391.js"><link rel="prefetch" href="/assets/js/25.028292c4.js"><link rel="prefetch" href="/assets/js/26.e48e58fe.js"><link rel="prefetch" href="/assets/js/27.81a50ac9.js"><link rel="prefetch" href="/assets/js/28.c9b99067.js"><link rel="prefetch" href="/assets/js/29.3e398b0e.js"><link rel="prefetch" href="/assets/js/3.bf921ca6.js"><link rel="prefetch" href="/assets/js/31.4df929c1.js"><link rel="prefetch" href="/assets/js/32.883b799d.js"><link rel="prefetch" href="/assets/js/33.edff820f.js"><link rel="prefetch" href="/assets/js/34.a40dfb52.js"><link rel="prefetch" href="/assets/js/35.f84b2527.js"><link rel="prefetch" href="/assets/js/36.d9686c50.js"><link rel="prefetch" href="/assets/js/37.7e04f937.js"><link rel="prefetch" href="/assets/js/38.7e0cf189.js"><link rel="prefetch" href="/assets/js/39.06edca1d.js"><link rel="prefetch" href="/assets/js/4.01616d0a.js"><link rel="prefetch" href="/assets/js/40.556d0c76.js"><link rel="prefetch" href="/assets/js/41.9370ec30.js"><link rel="prefetch" href="/assets/js/42.efb2b09e.js"><link rel="prefetch" href="/assets/js/43.230fd681.js"><link rel="prefetch" href="/assets/js/44.f8baf234.js"><link rel="prefetch" href="/assets/js/45.9434cbfb.js"><link rel="prefetch" href="/assets/js/46.5ceab43d.js"><link rel="prefetch" href="/assets/js/47.49c5f096.js"><link rel="prefetch" href="/assets/js/48.94111e03.js"><link rel="prefetch" href="/assets/js/49.b430e466.js"><link rel="prefetch" href="/assets/js/5.103b1fc9.js"><link rel="prefetch" href="/assets/js/50.5576e684.js"><link rel="prefetch" href="/assets/js/51.868924b4.js"><link rel="prefetch" href="/assets/js/52.13030538.js"><link rel="prefetch" href="/assets/js/53.d14e23b5.js"><link rel="prefetch" href="/assets/js/54.692ba555.js"><link rel="prefetch" href="/assets/js/55.e7f4ee2b.js"><link rel="prefetch" href="/assets/js/56.b2192bd2.js"><link rel="prefetch" href="/assets/js/57.7f33c3ce.js"><link rel="prefetch" href="/assets/js/58.bebb810c.js"><link rel="prefetch" href="/assets/js/59.3bb5c8e3.js"><link rel="prefetch" href="/assets/js/6.8d2cb690.js"><link rel="prefetch" href="/assets/js/60.f7d443a1.js"><link rel="prefetch" href="/assets/js/61.03c84be3.js"><link rel="prefetch" href="/assets/js/62.4d23f330.js"><link rel="prefetch" href="/assets/js/63.9b7eb6eb.js"><link rel="prefetch" href="/assets/js/64.c9a3f7a5.js"><link rel="prefetch" href="/assets/js/65.f18871f6.js"><link rel="prefetch" href="/assets/js/66.3d2c74a6.js"><link rel="prefetch" href="/assets/js/67.df9620fc.js"><link rel="prefetch" href="/assets/js/68.4c78fe6f.js"><link rel="prefetch" href="/assets/js/69.5298627a.js"><link rel="prefetch" href="/assets/js/7.77ce0fba.js"><link rel="prefetch" href="/assets/js/70.269c5ebf.js"><link rel="prefetch" href="/assets/js/71.14b994cb.js"><link rel="prefetch" href="/assets/js/72.6e1a94ad.js"><link rel="prefetch" href="/assets/js/73.327ce2fa.js"><link rel="prefetch" href="/assets/js/74.9535cbd0.js"><link rel="prefetch" href="/assets/js/8.a85b50e1.js"><link rel="prefetch" href="/assets/js/9.f7ed37b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b9be157.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信小程序商城构建全栈应用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/daily-learn/PHP/wx-tp-fullstack/first.html" class="sidebar-link">微信小程序商城构建全栈应用（一）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/second.html" class="sidebar-link">微信小程序商城构建全栈应用（二）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/third.html" class="sidebar-link">微信小程序商城构建全栈应用（三）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fourth.html" class="sidebar-link">微信小程序商城构建全栈应用（四）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html" aria-current="page" class="active sidebar-link">微信小程序商城构建全栈应用（五）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#身份权限体系" class="sidebar-link">身份权限体系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#实现身份权限体系" class="sidebar-link">实现身份权限体系</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#获取openid" class="sidebar-link">获取openid</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#用户保存及生成令牌" class="sidebar-link">用户保存及生成令牌</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#小程序测试" class="sidebar-link">小程序测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#商品接口初步编写" class="sidebar-link">商品接口初步编写</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#闭包函数构建查询器" class="sidebar-link">闭包函数构建查询器</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#路由变量规则与分组" class="sidebar-link">路由变量规则与分组</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html#用户收货地址接口" class="sidebar-link">用户收货地址接口</a></li></ul></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/sixth.html" class="sidebar-link">微信小程序商城构建全栈应用（六）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html" class="sidebar-link">微信小程序商城构建全栈应用（七）</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微信小程序商城构建全栈应用-五"><a href="#微信小程序商城构建全栈应用-五" class="header-anchor">#</a> 微信小程序商城构建全栈应用（五）</h1> <p>本文主要介绍了身份权限体系Token令牌的相关信息、商品接口及用户收货地址接口的编写。</p> <h2 id="身份权限体系"><a href="#身份权限体系" class="header-anchor">#</a> 身份权限体系</h2> <p>首先对于部分<code>API</code>，我们不希望被他人任意调用，因此需要确定用户的身份对其做权限控制。在<code>API</code>是通过令牌进行用户的身份验证，这类似于用户账号密码登陆。用户每次调用接口都需要携带令牌，只有正确的令牌方可调用接口。</p> <p>大致流程如图：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191205230623.png" alt=""></p> <p>首先通过<code>getToken</code>接口获取令牌，然后再调用接口是携带获取的令牌，<strong>注意令牌可能在技术上是合法的，但可能身份权限不够，也无法正常调用接口。</strong></p> <p>主要验证以下三个权限：</p> <ol><li>验证是否合法</li> <li>验证是否有效</li> <li>验证是否具有权限</li></ol> <p>由于本项目是微信小程序后台接口，因此我们不需要在单独设置用户账号密码，可以延用微信的身份验证体系，否则需要给用户生成一个唯一的用户表示。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191205231447.png" alt=""></p> <p>其中<code>session_key</code>可以解密微信小程序返回的加密信息，用来获取用户的<code>userid</code>,其与<code>openid</code>的区别是， 同一个用户在不同的小程序，公众号和服务号拥有同一个<code>userid</code>，而<code>openid</code>却是不同的。<code>openid</code>除了用作身份标识，还可以用于支付等功能。由于<code>openid</code>没有失效期因此不能传到客户端中，必须存储在服务器中，因此需要我们生成一个时效性令牌，用来验证身份。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191205232455.png" alt=""></p> <h3 id="实现身份权限体系"><a href="#实现身份权限体系" class="header-anchor">#</a> 实现身份权限体系</h3> <p>首先新建<code>Token</code>控制器</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> Token
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后编写路由，注意这里使用的是post方式，因为对安全性有一定的要求。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/Token/user'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Token/getToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编写相关验证器：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> TokenGet <span class="token keyword">extends</span> <span class="token class-name">BaseValidate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'require|isNotEmpty'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'没有code无法获取Token'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// BaseValidate.php</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token punctuation">,</span> <span class="token variable">$rule</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span> <span class="token punctuation">,</span><span class="token variable">$data</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span> <span class="token punctuation">,</span><span class="token variable">$field</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>然后创建User模型，这里因为业务比较复杂，因此建议写在service层里。简单的，粒度较小的我们放在Model层里。service是建立model层之上的，因此没有与数据表对应的限制。这里我们编写<code>get</code>方法来获取token。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token comment">// app/api/service/UserToken.php</span>
 <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="获取openid"><a href="#获取openid" class="header-anchor">#</a> 获取openid</h3> <p>根据获取<code>token</code>的流程图可知，我们将小程序向微信服务器请求获得的<code>code</code>之后调用服务器接口来获取<code>openid</code></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191206001919.png" alt=""></p> <p>首先在extra文件夹中编写微信相关的配置文件,这里在appid, secret和js_code三个地方用了占位符。当使用login_url时动态填入数据。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// extra/wx.php</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'app_id'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'app+secret'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'login_url'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'https://api.weixin.qq.com/sns/jscode2session?appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=authorization_code'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后编写UserToken这个类</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> UserToken
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppID</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppSecret</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxLoginUrl</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppID</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.app_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppSecret</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.app_secret'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxLoginUrl</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.login_url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppID</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppSecret</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们需要使用php去curl发起http请求，很多地方都会用到，所以我们在公共文件<code>app/api/common.php</code>文件中编写一个公共函数，供全局使用。这里抛出的Exception我们用TP5内置的，因为该错误不需要返回给客户端，只供服务端使用。大部分都是经验性的编码，参考即可。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * @param string $url get请求地址
 * @param int $httpCode 返回状态码
 * @return mixed
 */</span>
<span class="token keyword">function</span> <span class="token function">curl_get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token variable">$http_code</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//初始化curl</span>
    <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置请求的url</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置获得的结果以字符串返回而不是输出</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//不做证书校验,部署在linux环境下请改为true</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置连接的等待的超时时间</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_CONNECTTIMEOUT</span>，<span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置数据传输的超时时间</span>
<span class="token comment">//    curl_setopt($ch,CURLOPT_TIMEOUT,500);</span>
    <span class="token comment">//发起请求</span>
    <span class="token variable">$file_contents</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取连接资源的最后一个http代码</span>
    <span class="token variable">$http_code</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//关闭请求</span>
    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回获取的资源数据</span>
    <span class="token keyword">return</span> <span class="token variable">$file_contents</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>继续在UserToken 这个类中编写get方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxLoginUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$wxResult</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'获取openid及session_key异常，微信内部错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$loginFail</span> <span class="token operator">=</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">,</span> <span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$loginFail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>因为微信对返回的错误码都有对应的相关错误信息，因此这里需要我们编写异常处理方法<code>proccessLoginError</code>，并选择将错误信息返回给客户端，因此还需要编写异常处理器<code>WeChatException</code>，这里多写了一个方法是为了提高扩展性。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/api/service/UserToken.php</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">processLoginError</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WeChatException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errmsg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'errCode'</span> <span class="token operator">=&gt;</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">// app/lib/exception/WeChatException.php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">WeChatException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;微信服务器接口调用失败&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后完善UserToken的get接口</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/api/service/UserToken.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxLoginUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wxResult</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'获取openid及session_key异常，微信内部错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$loginFail</span> <span class="token operator">=</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">,</span> <span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$loginFail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">processLoginError</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">// 暂时return 查看结果</span>
            <span class="token keyword">return</span> <span class="token variable">$wxResult</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用授权接口</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 颁发令牌接口
 */</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到openid-&gt;查询数据库，不存在则新增记录-&gt;生成令牌，准备缓存数据，写入缓存-&gt;令牌返回至客户端</span>
    <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// v1/Token.php</span>
<span class="token keyword">class</span> <span class="token class-name">Token</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TokenGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ut</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserToken</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$ut</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>这里先暂时模拟微信获取登陆凭证<code>code</code></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191206151653.png" alt=""></p> <p>通过获取的<code>code</code>调用接口（code只能使用一次），注意这里使用的是<code>post raw</code>原生方式，且参数使用使用<code>JSON</code>格式传递，这里我们成功获取了<code>openid</code>和<code>session_key</code>。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191206160409.png" alt=""></p> <p><strong>注意：<code>RESTFUL</code>接口使用的都是原生方式传参。</strong></p> <h3 id="用户保存及生成令牌"><a href="#用户保存及生成令牌" class="header-anchor">#</a> 用户保存及生成令牌</h3> <p>获取用户的<code>openid</code>之后，我们要去查询数据库，如果是新用户则保存至数据库，同时生成令牌，将其存入缓存，之后可以根据令牌从缓存中获取用户信息，而不是查询数据库。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/api/service/UserToken.php</span>
<span class="token keyword">class</span> <span class="token class-name">UserToken</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppID</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxAppSecret</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$wxLoginUrl</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppID</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.app_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppSecret</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.app_secret'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxLoginUrl</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wx.login_url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppID</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxAppSecret</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wxLoginUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$wxResult</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'获取openid及session_key异常，微信内部错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$loginFail</span> <span class="token operator">=</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">,</span> <span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$loginFail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">processLoginError</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">// 调用授权接口</span>
                <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 颁发令牌接口
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 拿到openid-&gt;查询数据库，不存在则新增记录-&gt;生成令牌，准备缓存数据，写入缓存-&gt;令牌返回至客户端</span>
        <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 第二步查询数据库</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">UserModel</span><span class="token operator">::</span><span class="token function">getByOpenID</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">newUser</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 第三步 存缓存 key: 令牌  value: wxResult,uid(代表用户唯一身份),scope(决定用户身份)</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 准备存入缓存的数据
     * 这里scope代表权限  是一串整型数字，数字越大，权限越大
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">prepareCachedValue</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$cachedValue</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">;</span>
        <span class="token variable">$cachedValue</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$uid</span><span class="token punctuation">;</span>
        <span class="token variable">$cachedValue</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scope'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 将新用户保存到数据库
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">newUser</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">UserModel</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'openid'</span><span class="token operator">=&gt;</span><span class="token variable">$openid</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">processLoginError</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WeChatException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errmsg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'errorCode'</span> <span class="token operator">=&gt;</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errcode'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// model/User.php</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getByOpenID</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span> <span class="token variable">$openid</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>注意这里<code>generateToken</code>方法是和<code>Token</code>相关的方法， 因此不适合放在<code>common.php</code>中，我们将其放置<code>UserToken.php</code>的基类<code>Token.php</code>中，还有一个原因是后面还要编写小程序的<code>APPToken</code>，因此将两个Token文件中的公共函数放置在其公共基类中，以此提高内聚性。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/api/service/Token.php</span>
<span class="token keyword">class</span> <span class="token class-name">Token</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 选取32个字符组成一组随机字符串</span>
        <span class="token variable">$randomChars</span> <span class="token operator">=</span> <span class="token function">getRandomChars</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为了安全性， 用三组字符串 进行md5加密</span>
        <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_TIME_FLOAT'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// salt 盐 特殊的加密信息</span>
        <span class="token variable">$salt</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'secure.token_salt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$randomChars</span><span class="token operator">.</span><span class="token variable">$timestamp</span><span class="token operator">.</span><span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中<code>getRandomChars</code>为公共函数，令牌中的加密盐信息保存在<code>secure.php</code>配置文件中</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// common.php</span>
<span class="token comment">/**
 * 获得随机字符串
 * @param $length
 * @return null|string
 */</span>
<span class="token keyword">function</span> <span class="token function">getRandomChars</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token variable">$strPol</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$max</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$strPol</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token variable">$length</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$str</span> <span class="token operator">.=</span> <span class="token variable">$strPol</span><span class="token punctuation">[</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$max</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// extra/scure.php</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 随机字符串</span>
    <span class="token string single-quoted-string">'token_salt'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'afHienogfrsfdFWEn'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>并在平常的配置文件<code>setting.php</code>文件中配置令牌的过期时间</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token string single-quoted-string">'token_expire_in'</span> <span class="token operator">=&gt;</span> <span class="token number">7200</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将生成的令牌信息存入缓存，并将令牌返回给前端</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
* 颁发令牌接口
*/</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">grantToken</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到openid-&gt;查询数据库，不存在则新增记录-&gt;生成令牌，准备缓存数据，写入缓存-&gt;令牌返回至客户端</span>
    <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token variable">$wxResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 第二步查询数据库</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">UserModel</span><span class="token operator">::</span><span class="token function">getByOpenID</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    	<span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">newUser</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 第三步 存缓存 key: 令牌  value: wxResult,uid(代表用户唯一身份),scope(决定用户身份)</span>
    <span class="token variable">$cachedValue</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">prepareCachedValue</span><span class="token punctuation">(</span><span class="token variable">$wxResult</span><span class="token punctuation">,</span> <span class="token variable">$uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">saveToCache</span><span class="token punctuation">(</span><span class="token variable">$cachedValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">saveToCache</span><span class="token punctuation">(</span><span class="token variable">$cachedValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 随机生成字符串</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将数组转为字符串</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$cachedValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//过期时间</span>
    <span class="token variable">$expire_in</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'setting.token_expire_in'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TP5封装的缓存函数 默认的是文件缓存</span>
    <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$expire_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    		<span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'服务器缓存异常'</span><span class="token punctuation">,</span>
    		<span class="token string single-quoted-string">'errorCode'</span> <span class="token operator">=&gt;</span> <span class="token number">10005</span><span class="token punctuation">,</span>
    	<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通用令牌异常类</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">TokenException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Token已过期或无效Token'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>这里由于返回前端的数据都要求是<code>JSON</code>格式的数据，因此这里在接口处我们返回一个关联数组，框架会默认将其序列化为<code>JSON</code>格式。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// v1/Token.php</span>
<span class="token keyword">class</span> <span class="token class-name">Token</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TokenGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ut</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserToken</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$ut</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'token'</span> <span class="token operator">=&gt;</span> <span class="token variable">$token</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="小程序测试"><a href="#小程序测试" class="header-anchor">#</a> 小程序测试</h3> <p>这里我们编写了小程序测试页面，然后点击申请令牌，就可以看到令牌存储到了缓存中。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191208222423.png" alt=""></p> <p>在php项目中我们可以看到缓存已经写入到了文件中</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209093535.png" alt=""></p> <h2 id="商品接口初步编写"><a href="#商品接口初步编写" class="header-anchor">#</a> 商品接口初步编写</h2> <p>前面实现了<code>Token</code>的实现，后面进行实现，这里先编写详情接口，首先编写路由。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product/:id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'api/:version.Product/getOne'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们在<code>product</code>模型中编写商品查询方法，首先商品查询分为商品的基础信息，商品详情和产品参数。编写该方法时应注意考虑模型关联。通过业务分析我们可以知道商品基础信息的图片是存在<code>image</code>表中。而商品详情有很多关于商品的图片，这些图片是存储在<code>product_img</code>表中，他们之间是一对多的关系。<code>product_img</code>表中并没有直接存储图片的地址，而是存储了<code>img_id</code>，从而间接的获取图片。同理<code>product</code>商品表和`product_property产品参数表也是一对多的关系。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209100500.png" alt=""></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209100524.png" alt=""></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209100543.png" alt=""></p> <p>创建<code>ProductImage</code>模型和<code>ProductProperty</code>模型，<code>ProductImage</code>和<code>Image</code>模型是一对一的关系，所以我们需要在<code>ProductImage</code>模型中编写与<code>Image</code>模型的关联</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// ProductImage.php</span>
<span class="token keyword">class</span> <span class="token class-name">ProductImage</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'delete_time'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'img_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'product_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">imgUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Image'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'img_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ProductProperty.php</span>
<span class="token keyword">class</span> <span class="token class-name">ProductProperty</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'product_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'delete_time'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后在<code>Product</code>模型中编写关联和详情获取</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">imgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ProductImage'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'product_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ProductProperty'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'product_id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getProductDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$product</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgs'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'properties'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$product</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在<code>Product</code>控制器中编写相关的接口</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// v1/controller/Product.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$product</span> <span class="token operator">=</span> <span class="token class-name static-context">ProductModel</span><span class="token operator">::</span><span class="token function">getProductDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$product</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProductMissException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="闭包函数构建查询器"><a href="#闭包函数构建查询器" class="header-anchor">#</a> 闭包函数构建查询器</h2> <p>上面接口返回的结果如图：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209185018.png" alt=""></p> <p>这里并没有返回图片地址，我们只是调用了和<code>ProductImage</code>模型的关联，并没有具体关联到<code>Image</code>模型，因此需要在<code>Product</code>模型中进行嵌套查询。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getProductDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token variable">$product</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgs.imgUrl'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'properties'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token variable">$product</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209185410.png" alt=""></p> <p>这里可以看到服务器没有返回正确的顺序，需要在服务端进行排序之后再返回给服务端，这里的排序是对<code>Product</code>模型下的关联属性来排序，因此需要闭包函数构建查询器，修改结果如图：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getProductDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token variable">$product</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgs'</span> <span class="token operator">=&gt;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgUrl'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     	<span class="token operator">-&gt;</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'asc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'properties'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
     	<span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token variable">$product</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这是再次访问接口，返回结果的顺序就正常了。</p> <h2 id="路由变量规则与分组"><a href="#路由变量规则与分组" class="header-anchor">#</a> 路由变量规则与分组</h2> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product/recent'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Product/getRecent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product/by_category'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Product/getAllInCategory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product/:id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'api/:version.Product/getOne'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过前几节知识，我们知道以上路由都可以正常访问，但是当我们把第一条路由放置到最后，在重新访问，会出现以下报错：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209174631.png" alt=""></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191209173038.png" alt=""></p> <p>因为这里匹配到了第二条路由，所以会报<code>ID</code>必须是正整数的错误。<code>TP5</code>的路由是按顺序匹配的，所以匹配到这里的第二条路由之后就不会再继续匹配后面的路由了。</p> <p>根据编写的路由可知，这里recent是个常量，而<code>:id</code>是个可变的参数，因此我们要对<code>:id</code>进行限定，必须是正整数时的时候才能访问此接口，否则需要继续匹配，修改如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product/:id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'api/:version.Product/getOne'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'\d+'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中第三个参数是可选项，第四个参数是对url传递的参数进行规则限定。当按上述修改之后即可正常访问。</p> <p>同时对于多条控制器下的方法，官方文档建议<strong>路由分组</strong>，匹配效率会比单条单条写要好。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/product'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/by_category'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Product/getAllInCategory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/:id'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'api/:version.Product/getOne'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'\d+'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/recent'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Product/getRecent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="用户收货地址接口"><a href="#用户收货地址接口" class="header-anchor">#</a> 用户收货地址接口</h2> <p>用户相关信息接口必须要有权限控制（接口保护），必须是特定的用户才具有访问接口的权限，而不像商品信息等接口没有相关的限制。</p> <p>**注意：**这里修改用户的相关信息，我们并不是通过前端直接传递<code>uid</code>进行修改，而是通过传递<code>Token</code>，后端再通过<code>Token</code>信息再缓存中获取用户的<code>uid</code>，避免用户传递错误的<code>uid</code>而修改了他人的信息。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191210100315.png" alt=""></p> <p>地址数据表中的字段如下图所示：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191210103217.png" alt=""></p> <p>首先新建<code>Address</code>控制器，然后定义地址更新方法，</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// v1/Address.php</span>
<span class="token keyword">class</span> <span class="token class-name">Address</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">createOrUpdateAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// validate/AddressNew.php</span>
<span class="token keyword">class</span> <span class="token class-name">AddressNew</span> <span class="token keyword">extends</span> <span class="token class-name">BaseValidate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span>  <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isNotEmpty'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'mobile'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isMobile'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'province'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isNotEmpty'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'city'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isNotEmpty'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'country'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isNotEmpty'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'detail'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'require|isNotEmpty'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>封装获取UID方法</strong></p> <p>我们在<code>service/Token.php</code>文件中封装获取<code>uid</code>的方法，首先编写<code>getCurrentTokenVar</code>通用方法，用于获取存在缓存中的特定信息，这里值是被缓存在文件中，是<code>json</code>格式（缓存至<code>redis</code>则为数组），为了操作方便，先将其转换为数组的形式</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Token.php</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 所有的token都应通过http的header传递，而不是body</span>
    <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取缓存中的数据</span>
    <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token class-name static-context">Cache</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 缓存已过期或者缓存异常</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       		<span class="token keyword">return</span> <span class="token variable">$vars</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'尝试获取的Token变量不存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
* 根据token获取uid
*/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$uid</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>模型新增和更新</strong></p> <p>继续完善上节控制器代码，并创建相关的模型关联，这里<code>User</code>和<code>UserAddress</code>模型是一对一的关系，因为我们规定一个用户只能有一个收货地址（若一个用户对应多个收货地址，那么就是一对多的关系），**在含有外键的表或模型中编写模型关联则使用<code>belongsTo</code>方法，如果在没有外键的表或模型中编写模型关联则使用<code>hasOne</code>方法。**因此这里使用<code>hasOne</code>方法，同时我们先写一段伪代码模仿客户端传值。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// model/User.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hasOne</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'UserAddress'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//v1/Address.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">createOrUpdateAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddressNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据token获取用户uid-&gt;</span>
    <span class="token comment">//根据uid查找用户是否存在，不存在抛出异常 -&gt;</span>
    <span class="token comment">//用户存在，获取提交的地址信息 -&gt;</span>
    <span class="token comment">//判断更新还是添加地址</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token class-name static-context">TokenService</span><span class="token operator">::</span><span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">UserModel</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$dataArray</span> <span class="token operator">=</span> <span class="token function">getDatas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取用户地址</span>
    <span class="token variable">$userAddress</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">-&gt;</span><span class="token property">address</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$userAddress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 通过模型关心新增数据</span>
    	<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$dataArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">//更新数据</span>
    	<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">address</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$dataArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>未查找到相关用户的异常：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> UserException <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'用户不存在'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>更新或者修改成功的消息提示：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> SuccessMessage <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span><span class="token comment">// 资源修改成功</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ok'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>关联的<code>UserAddress.php</code>模型</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> UserAddress <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'delete_time'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>参数过滤：</strong></p> <p>客户端传递的数据不一定就是安全的，可能传入一些额外的参数，如果直接将获取的参数数据直接保存到数据库，可能会将数据库中的信息进行覆盖。</p> <p>因此我们需要在获取客户端发送过来的参数根据验证器的规则来进行获取，首先在<code>BaseValidte</code>类中新增一个方法<code>getDataByRule</code>对传递的参数进行过滤筛选，同时编写验证<code>isMobile</code>验证函数。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">isMobile</span><span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token punctuation">,</span> <span class="token variable">$rule</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span> <span class="token punctuation">,</span><span class="token variable">$data</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span> <span class="token punctuation">,</span><span class="token variable">$field</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'^1(3|4|5|7|8)[0-9]\d{8}$^'</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$rule</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取指定参数的变量值
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getDataByRule</span><span class="token punctuation">(</span><span class="token variable">$arrays</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">,</span><span class="token variable">$arrays</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token class-name">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">,</span> <span class="token variable">$arrays</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 不允许包含user_id或者uid,防止恶意覆盖user_id外键</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'参数中包含非法的参数名user_id或者uid'</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$newArray</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">rule</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$newArray</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arrays</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$newArray</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>再对相应的控制器代码进行修改即可：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">createOrUpdateAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$validate</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddressNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$validate</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据token获取用户uid-&gt;</span>
    <span class="token comment">//根据uid查找用户是否存在，不存在抛出异常 -&gt;</span>
    <span class="token comment">//用户存在，获取提交的地址信息 -&gt;</span>
    <span class="token comment">//判断更新还是添加地址</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token class-name static-context">TokenService</span><span class="token operator">::</span><span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">UserModel</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对传递的数据进行过滤</span>
    <span class="token variable">$dataArray</span> <span class="token operator">=</span> <span class="token variable">$validate</span> <span class="token operator">-&gt;</span><span class="token function">getDataByRule</span><span class="token punctuation">(</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取用户地址</span>
    <span class="token variable">$userAddress</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">-&gt;</span><span class="token property">address</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$userAddress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 通过模型关心新增数据</span>
        <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$dataArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">//更新数据</span>
        <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">address</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$dataArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuccessMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/recoveryMonster/vuepress-blog/edit/master/docs/daily-learn/PHP/wx-tp-fullstack/fifth.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/18/2020, 11:31:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/daily-learn/PHP/wx-tp-fullstack/fourth.html" class="prev">
        微信小程序商城构建全栈应用（四）
      </a></span> <span class="next"><a href="/daily-learn/PHP/wx-tp-fullstack/sixth.html">
        微信小程序商城构建全栈应用（六）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.cbc27ffd.js" defer></script><script src="/assets/js/2.26d918e1.js" defer></script><script src="/assets/js/30.eda8afc0.js" defer></script>
  </body>
</html>
