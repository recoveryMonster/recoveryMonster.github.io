<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序商城构建全栈应用（三） | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/assets/css/0.styles.6b9be157.css" as="style"><link rel="preload" href="/assets/js/app.cbc27ffd.js" as="script"><link rel="preload" href="/assets/js/2.26d918e1.js" as="script"><link rel="preload" href="/assets/js/36.d9686c50.js" as="script"><link rel="prefetch" href="/assets/js/10.8324ee53.js"><link rel="prefetch" href="/assets/js/11.b3fae781.js"><link rel="prefetch" href="/assets/js/12.2f57424d.js"><link rel="prefetch" href="/assets/js/13.a1bd9044.js"><link rel="prefetch" href="/assets/js/14.a21b9547.js"><link rel="prefetch" href="/assets/js/15.a55f5787.js"><link rel="prefetch" href="/assets/js/16.69ae7d01.js"><link rel="prefetch" href="/assets/js/17.8305f7c6.js"><link rel="prefetch" href="/assets/js/18.5f682b15.js"><link rel="prefetch" href="/assets/js/19.a8e0ad12.js"><link rel="prefetch" href="/assets/js/20.d64b0ffc.js"><link rel="prefetch" href="/assets/js/21.bb3d1ce8.js"><link rel="prefetch" href="/assets/js/22.2807caaf.js"><link rel="prefetch" href="/assets/js/23.d7d23893.js"><link rel="prefetch" href="/assets/js/24.d84de391.js"><link rel="prefetch" href="/assets/js/25.028292c4.js"><link rel="prefetch" href="/assets/js/26.e48e58fe.js"><link rel="prefetch" href="/assets/js/27.81a50ac9.js"><link rel="prefetch" href="/assets/js/28.c9b99067.js"><link rel="prefetch" href="/assets/js/29.3e398b0e.js"><link rel="prefetch" href="/assets/js/3.bf921ca6.js"><link rel="prefetch" href="/assets/js/30.eda8afc0.js"><link rel="prefetch" href="/assets/js/31.4df929c1.js"><link rel="prefetch" href="/assets/js/32.883b799d.js"><link rel="prefetch" href="/assets/js/33.edff820f.js"><link rel="prefetch" href="/assets/js/34.a40dfb52.js"><link rel="prefetch" href="/assets/js/35.f84b2527.js"><link rel="prefetch" href="/assets/js/37.7e04f937.js"><link rel="prefetch" href="/assets/js/38.7e0cf189.js"><link rel="prefetch" href="/assets/js/39.06edca1d.js"><link rel="prefetch" href="/assets/js/4.01616d0a.js"><link rel="prefetch" href="/assets/js/40.556d0c76.js"><link rel="prefetch" href="/assets/js/41.9370ec30.js"><link rel="prefetch" href="/assets/js/42.efb2b09e.js"><link rel="prefetch" href="/assets/js/43.230fd681.js"><link rel="prefetch" href="/assets/js/44.f8baf234.js"><link rel="prefetch" href="/assets/js/45.9434cbfb.js"><link rel="prefetch" href="/assets/js/46.5ceab43d.js"><link rel="prefetch" href="/assets/js/47.49c5f096.js"><link rel="prefetch" href="/assets/js/48.94111e03.js"><link rel="prefetch" href="/assets/js/49.b430e466.js"><link rel="prefetch" href="/assets/js/5.103b1fc9.js"><link rel="prefetch" href="/assets/js/50.5576e684.js"><link rel="prefetch" href="/assets/js/51.868924b4.js"><link rel="prefetch" href="/assets/js/52.13030538.js"><link rel="prefetch" href="/assets/js/53.d14e23b5.js"><link rel="prefetch" href="/assets/js/54.692ba555.js"><link rel="prefetch" href="/assets/js/55.e7f4ee2b.js"><link rel="prefetch" href="/assets/js/56.b2192bd2.js"><link rel="prefetch" href="/assets/js/57.7f33c3ce.js"><link rel="prefetch" href="/assets/js/58.bebb810c.js"><link rel="prefetch" href="/assets/js/59.3bb5c8e3.js"><link rel="prefetch" href="/assets/js/6.8d2cb690.js"><link rel="prefetch" href="/assets/js/60.f7d443a1.js"><link rel="prefetch" href="/assets/js/61.03c84be3.js"><link rel="prefetch" href="/assets/js/62.4d23f330.js"><link rel="prefetch" href="/assets/js/63.9b7eb6eb.js"><link rel="prefetch" href="/assets/js/64.c9a3f7a5.js"><link rel="prefetch" href="/assets/js/65.f18871f6.js"><link rel="prefetch" href="/assets/js/66.3d2c74a6.js"><link rel="prefetch" href="/assets/js/67.df9620fc.js"><link rel="prefetch" href="/assets/js/68.4c78fe6f.js"><link rel="prefetch" href="/assets/js/69.5298627a.js"><link rel="prefetch" href="/assets/js/7.77ce0fba.js"><link rel="prefetch" href="/assets/js/70.269c5ebf.js"><link rel="prefetch" href="/assets/js/71.14b994cb.js"><link rel="prefetch" href="/assets/js/72.6e1a94ad.js"><link rel="prefetch" href="/assets/js/73.327ce2fa.js"><link rel="prefetch" href="/assets/js/74.9535cbd0.js"><link rel="prefetch" href="/assets/js/8.a85b50e1.js"><link rel="prefetch" href="/assets/js/9.f7ed37b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b9be157.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信小程序商城构建全栈应用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/daily-learn/PHP/wx-tp-fullstack/first.html" class="sidebar-link">微信小程序商城构建全栈应用（一）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/second.html" class="sidebar-link">微信小程序商城构建全栈应用（二）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/third.html" aria-current="page" class="active sidebar-link">微信小程序商城构建全栈应用（三）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#固有的异常处理思维" class="sidebar-link">固有的异常处理思维</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#自定义全局异常处理" class="sidebar-link">自定义全局异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#编写异常公共类" class="sidebar-link">编写异常公共类</a></li></ul></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#thinkphp5中的日志系统" class="sidebar-link">ThinkPHP5中的日志系统</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#全局异常处理加入日志" class="sidebar-link">全局异常处理加入日志</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/third.html#全局异常处理的应用" class="sidebar-link">全局异常处理的应用</a></li></ul></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fourth.html" class="sidebar-link">微信小程序商城构建全栈应用（四）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html" class="sidebar-link">微信小程序商城构建全栈应用（五）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/sixth.html" class="sidebar-link">微信小程序商城构建全栈应用（六）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html" class="sidebar-link">微信小程序商城构建全栈应用（七）</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微信小程序商城构建全栈应用-三"><a href="#微信小程序商城构建全栈应用-三" class="header-anchor">#</a> 微信小程序商城构建全栈应用（三）</h1> <p>此文主要描述了AOP切面编程的思想，全局异常处理流程以及日志记录的方法。</p> <p><strong>所谓AOP即在程序运行时，动态地将代码切入到类的指定方法、指定位置上的编程思想（面向切面的编程）。</strong> 下面的全局异常处理异常层就是运用了AOP思想，把代码抽象了起来，使得开发出更简洁、精炼的代码更容易，举个例子，看电影时需要票，但是检票人并不在意你是在线上购买的还是线下购买的，都会一一检查观影人是否能进入电影院。</p> <p><strong>异常处理流程：</strong></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128151235.png" alt=""></p> <p>存在问题：逐级进行抛异常处理之类的；有些异常没有捕获。
因此需要有一个全局异常处理来管理这些异常并作出统一的处理，必须要做两件事：1.需要记录日志；2.统一错误状态码和错误信息</p> <h2 id="固有的异常处理思维"><a href="#固有的异常处理思维" class="header-anchor">#</a> 固有的异常处理思维</h2> <p>首先我们抛出一个错误</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// model/Banner.php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Exception</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Banner</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$ex</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// TODO 可以记录日志</span>
            <span class="token keyword">throw</span> <span class="token variable">$ex</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: use ID to get banner information</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'this is a banner information'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// api/v1/Banner.php</span>
<span class="token comment">/**
     * 根据id获取指定的banner信息
     * @url banner/:id
     * @http GET
     * @id banner的id号
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$banner</span> <span class="token operator">=</span> <span class="token class-name static-context">BannerModel</span><span class="token operator">::</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>然后在<code>postman</code>中请求接口，在打开应用调试模式下，报如下错误：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128151825.png" alt=""></p> <p>当关闭应用调试模式时，请求出现以下页面</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128152003.png" alt=""></p> <p>开发网页的时候返回<code>html</code>页面来显示错误信息没有问题，但如果是开发<code>api</code>是不行的。</p> <p>在控制器中继续捕获异常：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
	<span class="token variable">$banner</span> <span class="token operator">=</span> <span class="token class-name static-context">BannerModel</span><span class="token operator">::</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$ex</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token variable">$err</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
		<span class="token string single-quoted-string">'error_code'</span> <span class="token operator">=&gt;</span> <span class="token number">10001</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$ex</span> <span class="token operator">-&gt;</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128152547.png" alt=""></p> <p>这里200表示请求拿到了想要的结果，但实际上是个异常，不应该为200，因此我们返回的是应该加上code码。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样就可以了，以上是比较习惯的思维方式。请求 的状态码相应的会变成<code>400Bad Request</code></p> <p>**记住一点：**代码越抽象，复用性越高；封装性越好，适应代码变化的能力就越强。</p> <h2 id="自定义全局异常处理"><a href="#自定义全局异常处理" class="header-anchor">#</a> 自定义全局异常处理</h2> <p><strong>异常主要分以下两类：</strong></p> <ol><li>由于用户行为导致的异常（没有通过校验器，没查询到结果），这种异常通常不需要进行日志的记录，但需要向用户返回具体的信息。</li> <li>服务器自身的异常（代码错误， 调用外部接口错误），这种异常需要我们记录日志，并通常不向用户返回具体的错误信息。</li></ol> <h3 id="编写异常公共类"><a href="#编写异常公共类" class="header-anchor">#</a> 编写异常公共类</h3> <p>首先我们要进行异常封装，只记录服务器错误，而用户引起的参数错误我们不仅从记录，否则错误日志过于庞大，且无用。</p> <p>**第一步：**建立异常处理文件夹exception,建议文件与模块目录同级，这样异常处理文件可以用于其它模块或项目，且建议放入lib目录下，便于移植到其他目录。</p> <p>建立异常处理基类<code>BaseException</code>并继承Exception,并处理抛出的异常错误。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Exception</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BaseException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span>
<span class="token punctuation">{</span>
    <span class="token comment">// HTTP状态码</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误信息</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'参数错误'</span><span class="token punctuation">;</span>

    <span class="token comment">// 自定义错误码</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>针对本项目自定义错误码分以下几种</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token number">999</span>  未知错误
<span class="token number">1</span> 开头为通用错误
<span class="token number">2</span> 商品类错误
<span class="token number">3</span> 主题类错误
<span class="token number">4</span> Banner类错误
<span class="token number">5</span> 类目类错误
<span class="token number">6</span> 用户类错误
<span class="token number">8</span> 订单类错误

<span class="token number">10000</span> 通用参数错误
<span class="token number">10001</span> 资源未找到
<span class="token number">10002</span> 未授权（令牌不合法）
<span class="token number">10003</span> 尝试非法操作（自己的令牌操作其他人数据）
<span class="token number">10004</span> 授权失败（第三方应用账号登陆失败）
<span class="token number">10005</span> 授权失败（服务器缓存异常）


<span class="token number">20000</span> 请求商品不存在

<span class="token number">30000</span> 请求主题不存在

<span class="token number">40000</span> Banner不存在

<span class="token number">50000</span> 类目不存在

<span class="token number">60000</span> 用户不存在
<span class="token number">60001</span> 用户地址不存在

<span class="token number">80000</span> 订单不存在
<span class="token number">80001</span> 订单中的商品不存在，可能已被删除
<span class="token number">80002</span> 订单还未支付，却尝试发货
<span class="token number">80003</span> 订单已支付过
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>**第二步：**需要开发者自定义异常处理类，来接管框架的异常处理，同时需要在应用配置文件<code>app.php</code>（tp5.0在<code>app/config.php</code>）中配置参数<code>exception_handle</code>。</p> <p>建立自定义异常处理类<code>ExceptionHandler</code>，重写<code>render()</code>方法对父类进行覆盖，代码如下：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128162536.png" alt=""></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Exception</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>Handle</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ExceptionHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handle</span>
<span class="token punctuation">{</span>
    <span class="token comment">// HTTP状态码</span>
    <span class="token keyword">private</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误信息</span>
    <span class="token keyword">private</span> <span class="token variable">$msg</span><span class="token punctuation">;</span>
    <span class="token comment">// 自定义错误码</span>
    <span class="token keyword">private</span> <span class="token variable">$errorCode</span><span class="token punctuation">;</span>
    <span class="token comment">// 还需要返回客户端当前的url地址</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">BaseException</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 判断抛出的错误是否是自定义异常</span>
            <span class="token comment">// 自定义异常，相关参数为BaseException 中的参数</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token property">msg</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">errorCode</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token property">errorCode</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'app_debug'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// //判断是否返回框架自带的错误页面</span>
                <span class="token keyword">return</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'服务器内部错误，不想告诉你'</span><span class="token punctuation">;</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">errorCode</span> <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取当前请求路径的url</span>
        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'error_code'</span><span class="token operator">=&gt;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">errorCode</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'request_url'</span><span class="token operator">=&gt;</span> <span class="token variable">$url</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 以json的形式返回错误</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>配置<code>exception_handle</code>:</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128162736.png" alt=""></p> <p>做完上一步就可以说封装好了，当我们需要抛出了非自定义特定的异常时，返回的信息如下所示：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// model/Banner</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
    	<span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$ex</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token comment">// TODO 可以记录日志</span>
    	<span class="token keyword">throw</span> <span class="token variable">$ex</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO: use ID to get banner information</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">'this is a banner information'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// v1/banner</span>
 <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$banner</span> <span class="token operator">=</span> <span class="token class-name static-context">BannerModel</span><span class="token operator">::</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        return json($banner);</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>此时抛出的是系统异常，因此接口请求得到如下信息：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128164627.png" alt=""></p> <p>如果是客户端（自定义的异常）操作有误导致则按照自定义的异常返回结果：
这个是任何条件服务器都返回null</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> Banner <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>编写抛出异常，即抛出<code>BannerMissException</code>这个异常类（这里的<code>BannerMissException</code>需要继承<code>BaseException</code>公共异常类，同时<code>BaseException</code>要继承框架自带的<code>Exception</code>类，简明的说，任何自定义异常类都要继承框架自带的异常类才能让自定义的异常处理类来接收自定义异常类，因为自定义异常处理类也有继承框架自带的异常处理类）</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BannerMissException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'请求的Banner不存在'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">40000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后判断抛出自定义异常即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// api/v1/Banner</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanner</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$banner</span> <span class="token operator">=</span> <span class="token class-name static-context">BannerModel</span><span class="token operator">::</span><span class="token function">getBannerById</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 抛出BannerMissException异常给render()方法，从而进行异常处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$banner</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BannerMissException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="thinkphp5中的日志系统"><a href="#thinkphp5中的日志系统" class="header-anchor">#</a> ThinkPHP5中的日志系统</h2> <p>在开发环境可以通过打印变量和调试来发现错误并纠正，但是如果在生产环境中是不允许随意修改来调试错误，只有等到新版本系统出来才能去改动生产环境的代码，因此生产环境通过日志（最好的方法）来排查错误。</p> <p>TP5的日志文件所在目录<code>runtime/log</code></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128171358.png" alt=""></p> <p>因为很多信息如果都作为日志去记录，则会出现很多无意义的记录信息，不仅耗费了很大的硬盘内存资源，同时也影响了错误的排查。TP5默认会记录全部，需要手动关闭，然后有选择的来记录日志。</p> <p><strong>修改日志保存的位置</strong></p> <p>针对TP5.1，在<code>/config/log.php</code>中进行修改 （建议与TP5一样在入口文件定义LOG_PATH常量）</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128171755.png" alt=""></p> <p>针对TP5，则需要在<code>config.php</code>这个文件，找到日志存放的位置，我们顺着找到，可能会出现在<code>REANTIME</code>那个目录下面。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128171946.png" alt=""></p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128172045.png" alt=""></p> <p>而我们只需要在<code>index.php</code>入口文件中重新定义<code>LOG_PATH</code>这个常量即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">//定义日志文件</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOG_PATH'</span><span class="token punctuation">,</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/../logs/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="全局异常处理加入日志"><a href="#全局异常处理加入日志" class="header-anchor">#</a> 全局异常处理加入日志</h2> <p>在修改log日志所在目录之后，我们还需关闭日志，使其在需要进行日志记录的时候在开启。</p> <p><code>tp5.1</code>关闭日志功能，需在<code>/thinkphp/convention.php</code>中将日志的<code>type</code>改为<code>test</code>,通过<code>ctrl+shift+r</code>进行全局查找（注意如果直接在<code>/config/log.php</code>下修改<code>type</code>并不管用，若将<code>close</code>设置为<code>true</code>的话，则全局关闭日志写入，在进行日志初始化操作也无法进行写入 ）</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128173638.png" alt=""></p> <p><code>tp5.0</code>关闭日志功能，则在<code>/app/config.php</code>直接将日志下的<code>type</code>改为<code>test</code>即可。</p> <p>此时已经关闭日志功能，若需要开启日志记录功能，则需要进行初始化，在**<code>ExceptionHandler.php</code>文件下开启日志功能**， 从而实现出现异常时才进行日志记录。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token comment">/**
  *将错误记录到日志中
  * @param Exception $e 异常抛出的错误
  */</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">recordErrorLog</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'File'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'path'</span> <span class="token operator">=&gt;</span>  <span class="token constant">LOG_PATH</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'level'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//只记录error以上的错误级别</span>
        <span class="token string single-quoted-string">'close'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 开启日志写入功能</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>注若日志里只想显示错误级别的日志，<code>tp5.0</code>直接初始化时候配置level即可，而<code>tp5.1</code>还需在<code>config/log.php</code>中将level级别改为error。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128184738.png" alt=""></p> <p>在当前类中需要将异常保存到日志的地方进行调用即可</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128180352.png" alt=""></p> <p>然后抛出系统异常，即可在将日志记录。</p> <h2 id="全局异常处理的应用"><a href="#全局异常处理的应用" class="header-anchor">#</a> 全局异常处理的应用</h2> <p>在验证参数是否合法时，比如这里的id，调试环境我们可以看到具体的服务器报错信息，但是在生产环境中却报出了服务器内部错误的相关信息，这让客户端无法知道准确的错误点在哪里。如何解决呢？在验证的<code>goCheck</code>方法里集成了整个验证层的验证工作，所以我们需要定义一个参数错误的异常类。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128182632.png" alt=""></p> <p>这是因为在基类验证器中我们直接抛出了系统错误而不是自定义的异常</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
* 对http传递的参数进行验证
* @return bool true
* @throws Exception 验证的错误信息
*/</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取http传递的参数</span>
    <span class="token variable">$params</span> <span class="token operator">=</span> \<span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对参数进行校验</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$err</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>因此我们需要编写一个参数异常类<code>ParameterException</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>exception</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ParameterException</span> <span class="token keyword">extends</span> <span class="token class-name">BaseException</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'参数错误'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后在<code>goCheck</code>方法中抛出参数异常即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取http传递的参数</span>
    <span class="token variable">$params</span> <span class="token operator">=</span> \<span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对参数进行校验</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$e</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            	<span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">error</span><span class="token punctuation">,</span>
<span class="token comment">//              'code' =&gt; 400,</span>
 <span class="token comment">//             'errorCode' =&gt; 10000</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//$e-&gt;msg = $this-&gt;error;</span>
        <span class="token keyword">throw</span> <span class="token variable">$e</span><span class="token punctuation">;</span>
        <span class="token comment">/*未设置全局异常处理机制的情况下直接抛出错误。
         * $error=$this-&gt;getError();
         //抛出错误  此时不能用批量验证
         throw new Exception($error);*/</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128184616.png" alt=""></p> <p>如果使用外部通过给对象赋值成员变量也未尝不可，但是我们建议有更好的一种写法，我们在初始化对象的成员变量赋值最好的方式是通过构造函数来初始化赋值操作，更加符合面向对象的基本特性。则实例化的时候即可传入参数，相应的构造函数（父类中创建即可）会进行处理。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> BaseException <span class="token keyword">extends</span> <span class="token class-name">Exception</span>
<span class="token punctuation">{</span>
    <span class="token comment">//http状态码</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span><span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">;</span>
    <span class="token comment">//错误信息</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span><span class="token operator">=</span><span class="token string single-quoted-string">'参数错误'</span><span class="token punctuation">;</span>
    <span class="token comment">//自定义状态码</span>
    <span class="token keyword">public</span> <span class="token variable">$errorCode</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 如果自定义异常类实例化的时候传递了参数  则获取其参数 否则使用默认参数
     * @param array $params 调用自定义异常类时传递的参数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">,</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token operator">=</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">,</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span><span class="token operator">=</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'errCode'</span><span class="token punctuation">,</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">errorCode</span><span class="token operator">=</span><span class="token variable">$params</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'errorCode'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>在<code>BaseValidate</code>文件中进行批量验证</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 对参数进行校验 batch进行批量验证</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后添加验证规则，请求即可</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128190538.png" alt=""></p> <p>当进行错误的请求之后</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191128193851.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/recoveryMonster/vuepress-blog/edit/master/docs/daily-learn/PHP/wx-tp-fullstack/third.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/18/2020, 11:31:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/daily-learn/PHP/wx-tp-fullstack/second.html" class="prev">
        微信小程序商城构建全栈应用（二）
      </a></span> <span class="next"><a href="/daily-learn/PHP/wx-tp-fullstack/fourth.html">
        微信小程序商城构建全栈应用（四）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.cbc27ffd.js" defer></script><script src="/assets/js/2.26d918e1.js" defer></script><script src="/assets/js/36.d9686c50.js" defer></script>
  </body>
</html>
