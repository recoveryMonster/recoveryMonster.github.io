<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序商城构建全栈应用（七） | 城南花已开</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/logo.ico">
    <meta name="description" content="所爱隔山海，城南花已开">
    
    <link rel="preload" href="/assets/css/0.styles.6b9be157.css" as="style"><link rel="preload" href="/assets/js/app.cbc27ffd.js" as="script"><link rel="preload" href="/assets/js/2.26d918e1.js" as="script"><link rel="preload" href="/assets/js/34.a40dfb52.js" as="script"><link rel="prefetch" href="/assets/js/10.8324ee53.js"><link rel="prefetch" href="/assets/js/11.b3fae781.js"><link rel="prefetch" href="/assets/js/12.2f57424d.js"><link rel="prefetch" href="/assets/js/13.a1bd9044.js"><link rel="prefetch" href="/assets/js/14.a21b9547.js"><link rel="prefetch" href="/assets/js/15.a55f5787.js"><link rel="prefetch" href="/assets/js/16.69ae7d01.js"><link rel="prefetch" href="/assets/js/17.8305f7c6.js"><link rel="prefetch" href="/assets/js/18.5f682b15.js"><link rel="prefetch" href="/assets/js/19.a8e0ad12.js"><link rel="prefetch" href="/assets/js/20.d64b0ffc.js"><link rel="prefetch" href="/assets/js/21.bb3d1ce8.js"><link rel="prefetch" href="/assets/js/22.2807caaf.js"><link rel="prefetch" href="/assets/js/23.d7d23893.js"><link rel="prefetch" href="/assets/js/24.d84de391.js"><link rel="prefetch" href="/assets/js/25.028292c4.js"><link rel="prefetch" href="/assets/js/26.e48e58fe.js"><link rel="prefetch" href="/assets/js/27.81a50ac9.js"><link rel="prefetch" href="/assets/js/28.c9b99067.js"><link rel="prefetch" href="/assets/js/29.3e398b0e.js"><link rel="prefetch" href="/assets/js/3.bf921ca6.js"><link rel="prefetch" href="/assets/js/30.eda8afc0.js"><link rel="prefetch" href="/assets/js/31.4df929c1.js"><link rel="prefetch" href="/assets/js/32.883b799d.js"><link rel="prefetch" href="/assets/js/33.edff820f.js"><link rel="prefetch" href="/assets/js/35.f84b2527.js"><link rel="prefetch" href="/assets/js/36.d9686c50.js"><link rel="prefetch" href="/assets/js/37.7e04f937.js"><link rel="prefetch" href="/assets/js/38.7e0cf189.js"><link rel="prefetch" href="/assets/js/39.06edca1d.js"><link rel="prefetch" href="/assets/js/4.01616d0a.js"><link rel="prefetch" href="/assets/js/40.556d0c76.js"><link rel="prefetch" href="/assets/js/41.9370ec30.js"><link rel="prefetch" href="/assets/js/42.efb2b09e.js"><link rel="prefetch" href="/assets/js/43.230fd681.js"><link rel="prefetch" href="/assets/js/44.f8baf234.js"><link rel="prefetch" href="/assets/js/45.9434cbfb.js"><link rel="prefetch" href="/assets/js/46.5ceab43d.js"><link rel="prefetch" href="/assets/js/47.49c5f096.js"><link rel="prefetch" href="/assets/js/48.94111e03.js"><link rel="prefetch" href="/assets/js/49.b430e466.js"><link rel="prefetch" href="/assets/js/5.103b1fc9.js"><link rel="prefetch" href="/assets/js/50.5576e684.js"><link rel="prefetch" href="/assets/js/51.868924b4.js"><link rel="prefetch" href="/assets/js/52.13030538.js"><link rel="prefetch" href="/assets/js/53.d14e23b5.js"><link rel="prefetch" href="/assets/js/54.692ba555.js"><link rel="prefetch" href="/assets/js/55.e7f4ee2b.js"><link rel="prefetch" href="/assets/js/56.b2192bd2.js"><link rel="prefetch" href="/assets/js/57.7f33c3ce.js"><link rel="prefetch" href="/assets/js/58.bebb810c.js"><link rel="prefetch" href="/assets/js/59.3bb5c8e3.js"><link rel="prefetch" href="/assets/js/6.8d2cb690.js"><link rel="prefetch" href="/assets/js/60.f7d443a1.js"><link rel="prefetch" href="/assets/js/61.03c84be3.js"><link rel="prefetch" href="/assets/js/62.4d23f330.js"><link rel="prefetch" href="/assets/js/63.9b7eb6eb.js"><link rel="prefetch" href="/assets/js/64.c9a3f7a5.js"><link rel="prefetch" href="/assets/js/65.f18871f6.js"><link rel="prefetch" href="/assets/js/66.3d2c74a6.js"><link rel="prefetch" href="/assets/js/67.df9620fc.js"><link rel="prefetch" href="/assets/js/68.4c78fe6f.js"><link rel="prefetch" href="/assets/js/69.5298627a.js"><link rel="prefetch" href="/assets/js/7.77ce0fba.js"><link rel="prefetch" href="/assets/js/70.269c5ebf.js"><link rel="prefetch" href="/assets/js/71.14b994cb.js"><link rel="prefetch" href="/assets/js/72.6e1a94ad.js"><link rel="prefetch" href="/assets/js/73.327ce2fa.js"><link rel="prefetch" href="/assets/js/74.9535cbd0.js"><link rel="prefetch" href="/assets/js/8.a85b50e1.js"><link rel="prefetch" href="/assets/js/9.f7ed37b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6b9be157.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="城南花已开" class="logo"> <span class="site-name can-hide">城南花已开</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常积累" class="dropdown-title"><span class="title">日常积累</span> <span class="arrow down"></span></button> <button type="button" aria-label="日常积累" class="mobile-dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily-learn/JavaScript/call-apply-bind-simulator.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/CSS/make-talkbubble.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/PHP/tp51-timestamp-autosave.html" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Git/git-des.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/daily-learn/Scaffold/Introduction.html" class="nav-link">
  Scaffold
</a></li></ul></div></div><div class="nav-item"><a href="/cs-basic/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/translation/Arrays-symbols-and-realms.html" class="nav-link">
  外文翻译
</a></div> <a href="https://github.com/recoveryMonster" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信小程序商城构建全栈应用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/daily-learn/PHP/wx-tp-fullstack/first.html" class="sidebar-link">微信小程序商城构建全栈应用（一）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/second.html" class="sidebar-link">微信小程序商城构建全栈应用（二）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/third.html" class="sidebar-link">微信小程序商城构建全栈应用（三）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fourth.html" class="sidebar-link">微信小程序商城构建全栈应用（四）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/fifth.html" class="sidebar-link">微信小程序商城构建全栈应用（五）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/sixth.html" class="sidebar-link">微信小程序商城构建全栈应用（六）</a></li><li><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html" aria-current="page" class="active sidebar-link">微信小程序商城构建全栈应用（七）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#下单相关参数检测" class="sidebar-link">下单相关参数检测</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#调用微信支付" class="sidebar-link">调用微信支付</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#微信预下单" class="sidebar-link">微信预下单</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#生成签名及微信回调处理" class="sidebar-link">生成签名及微信回调处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#支付流程测试" class="sidebar-link">支付流程测试</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#我的订单编写" class="sidebar-link">我的订单编写</a></li><li class="sidebar-sub-header"><a href="/daily-learn/PHP/wx-tp-fullstack/seventh.html#订单详情编写" class="sidebar-link">订单详情编写</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="微信小程序商城构建全栈应用-七"><a href="#微信小程序商城构建全栈应用-七" class="header-anchor">#</a> 微信小程序商城构建全栈应用（七）</h1> <p>本文主要介绍了微信支付服务端接口的编写和订单相关接口的编写  ，因为微信不提供个人开发微信支付的相关功能，因此这里只是模拟微信支付流程来编写相关业务逻辑。</p> <p>微信支付代码编写本身并不难，主要是将工作流程理清，下图是一个简单的流程图，相关支付的具体详情见<a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191217202254.png" alt=""></p> <h2 id="下单相关参数检测"><a href="#下单相关参数检测" class="header-anchor">#</a> 下单相关参数检测</h2> <p>这里我们新建一个 Pay 控制器，因为微信支付功能只能给用户使用，而不能让管理员支付，因此这里需要进行权限校验。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// v1/Pay.php</span>
<span class="token keyword">class</span> <span class="token class-name">Pay</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$beforeActionList</span><span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'checkExclusionScope'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'only'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'getPreOrder'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取订单号</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getPreOrder</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后定义路由：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/pay/pay_order'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Pay/getPreOrder'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由于支付的流程较为复杂，因此我们将相关业务代码下载<code>service/Pay.php</code>中。注意要将一个复杂的方法分隔成许多个小方法。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> Pay
<span class="token punctuation">{</span>
    <span class="token comment">// 订单主键id</span>
    <span class="token keyword">private</span> <span class="token variable">$orderID</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$orderNO</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$orderID</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$orderID</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订单号不允许为NULL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderID</span> <span class="token operator">=</span> <span class="token variable">$orderID</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>同时在调用微信服务器接口进行支付之前，我们还需要进行库存量检测，因为用户可能下单之后过了一段时间在进行支付。因为之前已经在<code>service/Order.php</code>中编写了检测库存状态的方法<code>getOrderStatus</code>，但要注意传递相关参数，因此我们需要编写一个对外公开库存量检测的方法。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Order.php</span>
<span class="token comment">// 对外公开库存量检测方法</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkOrderStock</span><span class="token punctuation">(</span><span class="token variable">$orderID</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 根据订单号获取下单相关信息  product_id ,count</span>
    <span class="token variable">$oProducts</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderProduct</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$orderID</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">oProducts</span> <span class="token operator">=</span> <span class="token variable">$oProducts</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据下单相关信息获取库存信息</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">products</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getProductsByOrder</span><span class="token punctuation">(</span><span class="token variable">$oProducts</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$status</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这时我们就可以在<code>service/Pay</code>中调用库存量检测方法，同时对客户端传递的唯一订单 ID 不仅要判断库存量不足的情况，还要进行以下情况的检测。</p> <ol><li>订单号可能不存在（在控制器中执行进行了基本变量类型的检测，而没有进行业务逻辑的检测）</li> <li><strong>订单号存在，但是订单号和当前用户不匹配</strong></li> <li>订单可能已经被支付</li> <li>库存量检测</li></ol> <p>首先检测最有可能发生的情况，一旦不通过检测 ，后续程序就不会执行，以节约服务器性能。其次是将最消耗服务器性能的检测尽量放到后面执行。</p> <p>因此我们需要在<code>service/Pay.php</code>中进行订单检测相关信息是否合法，在检查用户是否匹配时，我们将其检测方法写在<code>service/Token.php</code>中，供其他地方检测时调用，具体代码如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Pay.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">checkOrderValidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 进行库存量检测</span>
    <span class="token variable">$orderService</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token variable">$orderService</span><span class="token operator">-&gt;</span><span class="token function">checkOrderStock</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$status</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token variable">$status</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 检测订单是否符合业务逻辑</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">checkOrderValidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// 查询当前订单号的相关信息</span>
    <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderID</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果订单不存在</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 查看是否与当前用户匹配</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name static-context">Token</span><span class="token operator">::</span><span class="token function">isValidOperate</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">user_id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'msg'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'订单与用户不匹配'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'errorCode'</span><span class="token operator">=&gt;</span><span class="token number">10003</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检测订单是否已经被支付</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">status</span> <span class="token operator">!=</span> <span class="token class-name static-context">OrderStatusEnum</span><span class="token operator">::</span><span class="token constant">UNPAID</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderException</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'msg'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'该笔订单已被支付'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'errorCode'</span> <span class="token operator">=&gt;</span> <span class="token number">80003</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token number">400</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderNO</span> <span class="token operator">=</span> <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">order_no</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>检测当前用户操作是否合法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Token.php</span>
<span class="token comment">// 检测当前操作是否合法，如订单号的用户id和当前令牌里的uid是否相等</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">isValidOperate</span><span class="token punctuation">(</span><span class="token variable">$checkUID</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$checkUID</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'检查UID时必须传入一个被检查的UID'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$uid</span> <span class="token operator">==</span> <span class="token variable">$checkUID</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>订单状态相关信息单独存到<code>enum/OrderStatusEnum.php</code>文件中</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> OrderStatusEnum
<span class="token punctuation">{</span>
    <span class="token comment">//待支付</span>
    <span class="token keyword">const</span> <span class="token constant">UNPAID</span> <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 已支付</span>
    <span class="token keyword">const</span> <span class="token constant">PAID</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 已发货</span>
    <span class="token keyword">const</span> <span class="token constant">DELIVERED</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token comment">// 已支付，但库存量不足</span>
    <span class="token keyword">const</span> <span class="token constant">PAID_BUT_OUT_OFF</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="调用微信支付"><a href="#调用微信支付" class="header-anchor">#</a> 调用微信支付</h2> <p>上面我们已经完成支付订单的相关检测，这时候就需要调用微信服务器进行支付了，首先我们要将预订单发送到微信服务器，这里需要下载使用微信<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=11_1" target="_blank" rel="noopener noreferrer">官方的 SDK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，方便封装相关参数。</p> <h3 id="微信预下单"><a href="#微信预下单" class="header-anchor">#</a> 微信预下单</h3> <p><strong>注意：微信官方的 SDK 直接进行调用可能会出现部分问题，需要我们在业务中进行相关的修改。</strong></p> <p>将下载 SDK 中<code>lib</code>文件下的类库复制到项目文件夹下的<code>/extend/WxPay</code>目录中。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/blog/20191218172223.png" alt=""></p> <p>因为微信的 SDK 文件不属于 TP5 框架的文件，没有命名空间，因此不能像平常文件通过<code>use</code>来引入该文件，因此这里使用手动加载相关文件。我们可以使用 TP5 框架的 Loader 类中的<code>import</code>方法进行引入外部文件。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Loader</span><span class="token punctuation">;</span>
<span class="token comment">// extend/WxPay/WxPay.WxPay.Api.php</span>
<span class="token class-name static-context">Loader</span><span class="token operator">::</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WxPay.WxPay'</span><span class="token punctuation">,</span><span class="token constant">EXTEND_PATH</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.Api.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>**注意：**在未修改<code>EXTEND_PATH</code>这个常量时，<code>extend</code>文件夹下的相关文件如果存在命名空间，那么都可以被自动加载。</p> <p>因为微信 SDK 类库文件中的配置文件是一个<code>abstract</code>类，因此我们需要编写一个类去继承并重写其中所有的方法。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>// extend/WxPay/WxPayConfig.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * 	配置账号信息
 */</span>
<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'WxPay.Config.Interface.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span>  <span class="token string double-quoted-string">&quot;Config.php&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">WxPayConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WxPayConfigInterface</span><span class="token punctuation">{</span>
    <span class="token comment">//=======【基本信息设置】=======</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token constant">APPID</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetMerchantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token constant">MCHID</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//=======【支付相关配置：支付成功回调地址/签名方式】======</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">&quot;HMAC-SHA256&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//=======【curl代理设置】===========</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetProxy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$proxyHost</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$proxyPort</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$proxyHost</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;0.0.0.0&quot;</span><span class="token punctuation">;</span>
        <span class="token variable">$proxyPort</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//=======【上报信息配置】===========</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetReportLevenl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//=======【商户密钥信息-需要业务方继承】========</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token constant">KEY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetAppSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token constant">APPSECRET</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//=======【证书路径设置-需要业务方继承】========</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">GetSSLCertPath</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$sslCertPath</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$sslKeyPath</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$sslCertPath</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'../cert/apiclient_cert.pem'</span><span class="token punctuation">;</span>
        <span class="token variable">$sslKeyPath</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'../cert/apiclient_key.pem'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>并将<code>APPID</code>等相关信息，单独存放在<code>WxPay/Config.php</code>文件中</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> Config <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">APPID</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'your appid'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MCHID</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'your mech id'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">KEY</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'your mech key'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">APPSECRET</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'your appsecret'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在完成上述步骤之后，我们需要向微信预下单，封装相关下单参数：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Pay.php 微信预下单</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">makeWxPreOrder</span><span class="token punctuation">(</span><span class="token variable">$totalPrice</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$openid</span> <span class="token operator">=</span> <span class="token class-name static-context">Token</span><span class="token operator">::</span><span class="token function">getCurrentTokenVar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'openid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$wxOrderData</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayUnifiedOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置订单号</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetOut_trade_no</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderNO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置交易类型</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetTrade_type</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'JSAPI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置交易金额 单位为分</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetTotal_fee</span><span class="token punctuation">(</span><span class="token variable">$totalPrice</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置订单描述</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetBody</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'零食商贩'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置用户身份标识</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetOpenid</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置回调地址 这里需要编写方法来接受小程序返回的回调地址</span>
        <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetNotify_url</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在封装完相关预订单参数之后，我们需要调用微信的预定单接口，从而获得微信服务器端返回的签名，注意这里实例化的<code>WxPayConfig</code>就是我们自己编写的微信支付信息配置文件，这里同样需要进行引入。除了上面所说的<code>Loader</code>类中的方法引入外，我们还可以使用<code>require_once</code>进行文件的引入：</p> <div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token constant">EXTEND_PATH</span><span class="token operator">.</span><span class="token string single-quoted-string">'WxPay'</span><span class="token operator">.</span><span class="token constant">DS</span><span class="token operator">.</span><span class="token string single-quoted-string">'WxPay.Config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">getPaySignature</span><span class="token punctuation">(</span><span class="token variable">$wxOrderData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向微信统一下单</span>
        <span class="token variable">$wxOrder</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>WxPayApi</span><span class="token operator">::</span><span class="token function">unifiedOrder</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token variable">$wxOrderData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断接口是否调用成功</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'return_code'</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token string single-quoted-string">'SUCCESS'</span> <span class="token operator">||</span>
            <span class="token variable">$wxOrder</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'result_code'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">'SUCCESS'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span><span class="token comment">// 记录日志</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'获取预支付订单失败'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'获取预支付订单失败，'</span><span class="token operator">.</span><span class="token variable">$wxOrder</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'err_code_des'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这里我们先进行以下调试，看微信预订单接口是否能否走通。首先先将相关信息返回：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Pay.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
	 <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">makeWxPreOrder</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'orderPrice'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 微信预下单</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">makeWxPreOrder</span><span class="token punctuation">(</span><span class="token variable">$totalPrice</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getPaySignature</span><span class="token punctuation">(</span><span class="token variable">$wxOrderData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">getPaySignature</span><span class="token punctuation">(</span><span class="token variable">$wxOrderData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token comment">// 暂时先返回空字符串</span>
<span class="token punctuation">}</span>
<span class="token comment">// v1/Order.php</span>
<span class="token comment">// 获取订单号</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getPreOrder</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pay</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayService</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$pay</span><span class="token operator">-&gt;</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>同时因为我们只是在本地进行相关测试，因此还需将微信 API 类中的相关 curl 参数验证设置为 false。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_SSL_VERIFYHOST</span><span class="token punctuation">,</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//严格校验</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在微信小程序上调用支付方法，调试可以发现报如下错误：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191218224905.png" alt=""></p> <p>这是因为我们之前没有编写获取回调地址的方法，于是将此值设置为了空，我们这里随便填写一个地址继续测试：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetNotify_url</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191218230854.png" alt=""></p> <p>返回结果如上所示，就说明我们的预下单已经成功。其中<code>prepay_id</code>可以用来向用户推送相关模板消息。</p> <h3 id="生成签名及微信回调处理"><a href="#生成签名及微信回调处理" class="header-anchor">#</a> 生成签名及微信回调处理</h3> <h4 id="生成签名"><a href="#生成签名" class="header-anchor">#</a> 生成签名</h4> <p>在完成微信预下单之后，我们需要将<code>prepay_id</code>保存到数据库，方便后期调用。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Pay.php</span>
<span class="token comment">// 保存prepay_id</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">recordPrepayID</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">orderID</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'prepay_id'</span><span class="token operator">=&gt;</span><span class="token variable">$wxOrder</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'prepay_id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后我们需要返回一系列参数至客户端，由客户端去吊起微信支付，相关详细信息见<a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/payment/wx.requestPayment.html" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。其中需要我们返回一个签名字段。其抽象如下，因为相关订单参数在传递的过程种可能会被篡改，因此需要使用签名。但没有完全保证参数不被篡改地方法。签名是通过参数加 APPkey 通过一定的算法生成，当客户端将算法和参数一起传递到微信服务端时，微信服务端同样通过算法生成签名，与客户端的签名进行对比，进行判断。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191218232914.png" alt=""></p> <p>这里我们编写获取吊起微信支付参数的方法并返回至客户端。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// service/Pay.php</span>
<span class="token comment">// 生成支付数据的签名及相关支付参数</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$jsApiPayData</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayJsApiPay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 相关参数文档 https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&amp;index=3</span>
    <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">SetAppid</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ex.app_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">SetTimeStamp</span><span class="token punctuation">(</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成随机串</span>
    <span class="token variable">$rand</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">SetTimeStamp</span><span class="token punctuation">(</span><span class="token variable">$rand</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">SetPackage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'prepay_id='</span><span class="token operator">.</span><span class="token variable">$wxOrder</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'prepay_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">SetSignType</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'MD5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 微信封装的生成sign方法</span>
    <span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">MakeSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取参数数组</span>
    <span class="token variable">$rawValues</span> <span class="token operator">=</span> <span class="token variable">$jsApiPayData</span><span class="token operator">-&gt;</span><span class="token function">GetValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将生成的签名添加到数组中</span>
    <span class="token variable">$rawValues</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paySign'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$sign</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为数组中还携带appid 而客户端并不用appid这个参数</span>
    <span class="token comment">// 而且有些时候我们也不希望返回这个参数，因袭我们将其删除</span>
    <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$rawValues</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'appId'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$rawValues</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token comment">// 获取签名</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">getPaySignature</span><span class="token punctuation">(</span><span class="token variable">$wxOrderData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">recordPrepayID</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$signature</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token variable">$wxOrder</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$signature</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>小程序根据服务器返回的结果拉起微信支付，微信会分别返回给客户端和服务器一个支付的结果（异步）通知。</p> <h4 id="回调处理"><a href="#回调处理" class="header-anchor">#</a> 回调处理</h4> <p>我们先编写收到回调的处理方法并定义相关路由供微信访问：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// v1/Pay.php</span>
<span class="token comment">// 获取支付通知</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">receiveNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment">// 通知频率为15/15/30/180/1800/1800/1800/3600</span>
<span class="token comment">// 只有返回正确的处理消息或者超时才会停止访问</span>
<span class="token punctuation">}</span>
<span class="token comment">// route.php</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/pay/notify'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Pay/receiveNotify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当服务端收到微信通知时需要做以下三件事：</p> <ol><li>检测库存量，超卖</li> <li>更新这个订单的 status 状态</li> <li>减库存</li></ol> <p>如果成功处理以上步骤，需要给微信返回成功处理的消息，那么微信就会停止调用接口，如果没有成功处理，则会继续调用接口。</p> <p>微信支付回调接口有以下两个特点：</p> <ul><li>post形式访问，且不能使用路由传参的形式</li> <li>返回 xml 格式，使用微信自带的 SDK 中<code>WxPay.Notify.php</code>提供了相关的方法将其转换为相关数组</li></ul> <p>这里需要我们覆盖入口方法，支付回到成功返回的参数见<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191219001947.png" alt=""></p> <p>然后我们新建一个类并重写该方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>service</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Loader</span><span class="token operator">::</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WxPay.WxPay'</span><span class="token punctuation">,</span><span class="token constant">EXTEND_PATH</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.notify.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">WxNotify</span> <span class="token keyword">extends</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayNotify</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">NotifyProcess</span><span class="token punctuation">(</span><span class="token variable">$objData</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$msg</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$objData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'result_code'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'SUCCESS'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$orderNo</span> <span class="token operator">=</span> <span class="token variable">$objData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'trade_order_no'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_no'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$orderNo</span><span class="token punctuation">)</span>
                    <span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">status</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$orderService</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$stockStatus</span> <span class="token operator">=</span> <span class="token variable">$orderService</span><span class="token operator">-&gt;</span><span class="token function">checkOrderStock</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$stockStatus</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span> <span class="token comment">// 库存量检测成功</span>
                        <span class="token comment">// 更新订单状态</span>
                        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 减少库存</span>
                        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token variable">$stockStatus</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">,</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 错误信息记录日志</span>
                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span> <span class="token comment">// 订单支付失败，返回true，让微信不在调用通知接口</span>
            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新订单状态</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token variable">$orderID</span><span class="token punctuation">,</span> <span class="token variable">$success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token variable">$success</span> <span class="token operator">?</span> <span class="token class-name static-context">OrderStatusEnum</span><span class="token operator">::</span><span class="token argument-name">PAID</span>
            <span class="token punctuation">:</span> <span class="token class-name static-context">OrderStatusEnum</span><span class="token operator">::</span><span class="token constant">PAID_BUT_OUT_OFF</span><span class="token punctuation">;</span>
        <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$orderID</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token operator">=&gt;</span><span class="token variable">$status</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 减少库存</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token variable">$stockStatus</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 订单商品状态信息</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$stockStatus</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pStatusArray'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$singlePStatus</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$singlePStatus</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">-&gt;</span><span class="token function">setDec</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'stock'</span><span class="token punctuation">,</span><span class="token variable">$singlePStatus</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>注意，这里检测库存量及后面的操作时，是在数据库中订单尚未支付的情况下进行检测及后续操作，否则每次微信调用接口，都会进行这一系列操作是不合理的。</p> <h4 id="事务与锁防止多次减库存"><a href="#事务与锁防止多次减库存" class="header-anchor">#</a> <strong>事务与锁防止多次减库存</strong></h4> <p>在上述回调重写过程中，是有可能产生多次减库存的操作。例如，当第一次回调时，在进行库存量的检测还没有修改订单状态的时候，查询数据库的过程比较慢，导致下一次回调的时候，还没有修改订单的状态，这时候就会导致多次减库存的发生。</p> <p>因此我们在这里可以使用事务操作，在第一次通过 OrderModel 查询订单信息的时候将表锁住，直至事务操作完成，才可以进行下一次的操作。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">startTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span>
<span class="token punctuation">{</span><span class="token comment">// ...</span>
    <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token comment">// ...</span>
	<span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果需要对于单独的数据库操作，我们可以单独对其加锁如下所示：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_no'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$orderNo</span><span class="token punctuation">)</span>
	<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span>
	<span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后我们在<code>Pay</code>控制器中编写接收微信回调的方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token constant">EXTEND_PATH</span><span class="token operator">.</span><span class="token string single-quoted-string">'WxPay'</span><span class="token operator">.</span><span class="token constant">DS</span><span class="token operator">.</span><span class="token string single-quoted-string">'WxPay.Config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 获取支付通知</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">receiveNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 通知频率为15/15/30/180/1800/1800/1800/3600</span>
        <span class="token comment">// 只有返回正确的处理消息就会停止访问</span>
        <span class="token comment">//1. 检测库存量，超卖</span>
        <span class="token comment">//2. 更新这个订单的 status 状态</span>
        <span class="token comment">//3. 减库存</span>
        <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$notify</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这里没有直接调用<code>WxNotify</code>中的重写的<code>NotifyProcess</code>方法，是因为其需要接收三个参数，而这三个参数是在父类<code>Handle</code>处理方法中获取并自行调用<code>NotifyProcess</code>方法，并且<code>Handle</code>方法会将微信返回的<code>xml</code>格式信息转换为数组格式进行处理。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221160412.png" alt=""></p> <p>此时我们还要设置微信支付的回调地址，使微信服务器能正确调用我们的回调方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// extra/secure.php</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'pay_back_url'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'http://wxtp.io/api/v1/pay/notify'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// service/Pay.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> makeWxPreOrder<span class="token punctuation">{</span>
     <span class="token comment">// 设置回调地址 这里需要编写方法来接受小程序返回的回调地址</span>
     <span class="token variable">$wxOrderData</span><span class="token operator">-&gt;</span><span class="token function">SetNotify_url</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'secure.pay_back_url'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但是我们是本地服务器，并不能直接供微信服务器回调，因此需要反向代理软件 <a href="https://dashboard.ngrok.com/" target="_blank" rel="noopener noreferrer">Ngrok<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，间接的将本地服务器转换为网上服务器。但是这种方法不安全，因此最好使用阿里云等部署代码。</p> <p>这里我们使用内网穿透的地址如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token string single-quoted-string">'pay_back_url'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'http://bf91b369.ngrok.io/WeChat-Shop-TP/api/v1/pay/notify'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="支付流程测试"><a href="#支付流程测试" class="header-anchor">#</a> 支付流程测试</h2> <p>这里我们首先使用 Postman 对回调接口进行测试，会出现以下报错。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221165303.png" alt=""></p> <p>这里是我们直接在<code>service/WxNotify.php</code>中引入了<code>WxPay.Notify.php</code>文件，实际上必须通过<code>WxPay.Api.php</code>文件进行间接引用，因此需要进行如下修改</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>service</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Loader</span><span class="token operator">::</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'WxPay.WxPay'</span><span class="token punctuation">,</span><span class="token constant">EXTEND_PATH</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.Api.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>并在<code>WxPay.Api.php</code>文件中引入<code>WxPay.Notify.php</code>文件。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">require_once</span> <span class="token string double-quoted-string">&quot;WxPay.Notify.php&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再次请求，如果报如下错误就说明已经可以正常进行微信回到了，因此我们可以通过微信进行完整的下单测试了。</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221165909.png" alt=""></p> <p>如果只针对回调进行 Debug 调试的话，需要我们进行转发接口的编写，因为微信服务器会自动忽略路由传递的参数。将微信预下单返回的参数获取，然后再通过转发接口访问即可进行回调调试。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 获取支付通知</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">receiveNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$xmlData</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_post_raw</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'http://wxtp.io/api/v1/pay/re_notify'</span><span class="token punctuation">,</span><span class="token variable">$xmlData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 回调转发接口</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">redirectNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 通知频率为15/15/30/180/1800/1800/1800/3600</span>
        <span class="token comment">// 只有返回正确的处理消息就会停止访问</span>
        <span class="token comment">//1. 检测库存量，超卖</span>
        <span class="token comment">//2. 更新这个订单的 status 状态</span>
        <span class="token comment">//3. 减库存</span>
        <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>WxPayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$notify</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>接口地址编写</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/pay/re_notify'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Pay/redirect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编写 post 请求的公共方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// api/common.php</span>
<span class="token keyword">function</span> <span class="token function">curl_post_raw</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$rawData</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CONNECTTIMEOUT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POST</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token variable">$rawData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span>
        <span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HTTPHEADER</span><span class="token punctuation">,</span>
        <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token string single-quoted-string">'Content-Type: text'</span> <span class="token comment">// 这里微信返回的是xml格式的文本，因此设置为text</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="我的订单编写"><a href="#我的订单编写" class="header-anchor">#</a> 我的订单编写</h2> <p>用户在查询历史订单时，要按购买时间继续排序，并且由于一个人的历史订单可能有很多条，因此需要进行分页处理。</p> <p>页面如下所示：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221225150.png" alt=""></p> <p>然后在<code>v1/Order.php</code>控制器中编写获取用户的历史订单信息方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 前置方法</span>
  <span class="token keyword">protected</span> <span class="token variable">$beforeActionList</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string single-quoted-string">'checkExclusionScope'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'only'</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'placeOrder'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string single-quoted-string">'checkPrimaryScope'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'only'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'getSummaryByUser'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 获取用户的简要订单信息 管理员也可以查看用户的订单信息</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getSummaryByUser</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PagingParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$uid</span> <span class="token operator">=</span> <span class="token class-name static-context">TokenService</span><span class="token operator">::</span><span class="token function">getCurrentUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pagingOrders</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">getSummaryByuser</span><span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$pagingOrders</span><span class="token operator">-&gt;</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'data'</span><span class="token operator">=&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'current_page'</span><span class="token operator">=&gt;</span><span class="token variable">$pagingOrders</span><span class="token operator">-&gt;</span><span class="token function">getCurrentPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$pagingOrders</span> <span class="token operator">-&gt;</span><span class="token function">hidden</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'snap_item'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'snap_address'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'prepay_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'data'</span><span class="token operator">=&gt;</span><span class="token variable">$data</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'current_page'</span><span class="token operator">=&gt;</span><span class="token variable">$pagingOrders</span><span class="token operator">-&gt;</span><span class="token function">getCurrentPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>其对应的路由、验证器和模型方法的编写：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 路由</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/order/by_user'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Order/getSummaryByUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// model/Order.php</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getSummaryByuser</span><span class="token punctuation">(</span><span class="token variable">$uid</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
     <span class="token variable">$pageData</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token variable">$uid</span><span class="token punctuation">)</span>
         <span class="token operator">-&gt;</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'create_time desc'</span><span class="token punctuation">)</span>
         <span class="token operator">-&gt;</span><span class="token function">paginate</span><span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'page'</span><span class="token operator">=&gt;</span><span class="token variable">$page</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token variable">$pageData</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token comment">// 验证器</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>validate</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">PagingParameter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseValidate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'page'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'isPositiveInt'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'size'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'isPositiveInt'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'page'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'分页参数必须是正整数'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'size'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'分页参数必须是正整数'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="订单详情编写"><a href="#订单详情编写" class="header-anchor">#</a> 订单详情编写</h2> <p>这里我们根据订单号获取订单详情，而管理员也应该具有该权限，因此编写方法如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 前置方法</span>
<span class="token keyword">protected</span> <span class="token variable">$beforeActionList</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'checkExclusionScope'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'only'</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'placeOrder'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'checkPrimaryScope'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'only'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'getDetail,getSummaryByUser'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 获取订单详情</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getDetail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IDMustBePositiveInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">goCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$orderDetail</span> <span class="token operator">=</span> <span class="token class-name static-context">OrderModel</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$orderDetail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   	<span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$orderDetail</span><span class="token operator">-&gt;</span><span class="token function">hidden</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'prepay_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>编写了该方法，定义路由如下，然后进行测试：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api/:version/order/:id'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'api/:version.Order/getDetail'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'\d+'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221231421.png" alt=""></p> <p>根据返回的结果我们可以看到 snap_items 和 snap_address 是 JSON 字符串，这个是不符合接口要求的，因为正常接口应该返回 JSON  对象，所以我们需要在模型中编写相关读取器的方法，使其返回正确的格式。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getSnapItemsAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   		<span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getSnapAddressAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这时返回的结果如下图所示：</p> <p><img src="https://raw.githubusercontent.com/recoveryMonster/HexoImages/master/Gridea/20191221231829.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/recoveryMonster/vuepress-blog/edit/master/docs/daily-learn/PHP/wx-tp-fullstack/seventh.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/18/2020, 11:31:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/daily-learn/PHP/wx-tp-fullstack/sixth.html" class="prev">
        微信小程序商城构建全栈应用（六）
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.cbc27ffd.js" defer></script><script src="/assets/js/2.26d918e1.js" defer></script><script src="/assets/js/34.a40dfb52.js" defer></script>
  </body>
</html>
